<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNOMED CT Editorial Guide Browser | SNOMED International</title>
    <meta name="description" content="Interactive browser for the SNOMED CT Editorial Guide - comprehensive clinical terminology management guidelines from SNOMED International">
    <meta name="keywords" content="SNOMED CT, clinical terminology, healthcare, medical coding, SNOMED International, editorial guide">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè•</text></svg>">
    
    <!-- No framework dependencies - Pure JavaScript -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Configuration and Services -->
    <script src="config.js"></script>
    <script src="gemini-service.js"></script>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --header-height: 64px;
            --footer-height: 200px;
            --primary-color: #374151;
            --primary-light: #4b5563;
            --primary-dark: #1f2937;
            --secondary-color: #6b7280;
            --accent-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --text-primary: #374151;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --border-color: #e5e7eb;
            --border-light: #f3f4f6;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --radius-xl: 12px;
            
            /* Enhanced pastel color palette */
            --pastel-blue: #dbeafe;
            --pastel-green: #dcfce7;
            --pastel-purple: #e9d5ff;
            --pastel-orange: #fed7aa;
            --pastel-pink: #fce7f3;
            --pastel-yellow: #fef3c7;
            --pastel-red: #fee2e2;
            --pastel-teal: #ccfbf1;
            --pastel-indigo: #e0e7ff;
            --pastel-cyan: #cffafe;
            --pastel-lime: #ecfccb;
            --pastel-rose: #ffe4e6;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding-top: var(--header-height);
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            margin: 0;
            display: flex;
            flex-direction: column;
        }
        
        /* Ensure the main wrapper takes full height */
        .min-h-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Header Styles - Clean and simple */
        header {
            height: var(--header-height);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }
        
        header .container {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0;
            max-width: none;
            margin: 0;
            width: 100%;
        }
        
        /* Ensure logo and title are properly aligned */
        header .flex.items-center img {
            flex-shrink: 0;
        }
        
        /* Ensure search and actions are properly spaced */
        header .flex.items-center.space-x-4 {
            flex-shrink: 0;
        }
        
        /* Push elements to the edges */
        header .flex.items-center.justify-between > div:first-child {
            padding-left: 2rem;
        }
        
        header .flex.items-center.justify-between > div:last-child {
            padding-right: 2rem;
            margin-left: auto;
        }
        
        /* Ensure proper spacing between left and right elements */
        header .flex.items-center.justify-between {
            width: 100%;
        }
        
        /* Sidebar navigation - Light gray background */
        .sidebar-nav {
            background: var(--bg-secondary);
            border-radius: 0;
            box-shadow: var(--shadow-md);
            padding: 0;
            height: 100%;
            border-right: 1px solid var(--border-color);
        }
        
        /* Main content area - White background */
        .main-content {
            background: var(--bg-primary);
            min-height: calc(100vh - var(--header-height) - var(--footer-height));
            padding: 2rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            width: calc(100vw - 320px);
        }
        
        @media (max-width: 1024px) {
            .main-content {
                width: 100vw;
                margin-left: 0 !important;
            }
        }
        
        /* Concept ID styling */
        .concept-id {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }
        
        /* Enhanced Markdown Content Styling */
        .markdown-content {
            line-height: 1.7;
            color: var(--text-primary);
        }
        
        .markdown-content h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--pastel-blue);
        }
        
        .markdown-content h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 1.5rem 0 1rem 0;
            padding: 0.5rem 0;
            background: var(--pastel-green);
            padding-left: 1rem;
            border-radius: var(--radius-sm);
        }
        
        .markdown-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 1.25rem 0 0.75rem 0;
            padding-left: 0.5rem;
            border-left: 3px solid var(--pastel-purple);
        }
        
        .markdown-content h4 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 1rem 0 0.5rem 0;
            background: var(--pastel-yellow);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            display: inline-block;
        }
        
        .markdown-content p {
            margin: 1rem 0;
            line-height: 1.7;
            color: var(--text-primary);
        }
        
        .markdown-content ul, .markdown-content ol {
            margin: 1rem 0;
            padding-left: 1.5rem;
        }
        
        .markdown-content li {
            margin: 0.5rem 0;
            line-height: 1.6;
        }
        
        .markdown-content ul li {
            list-style-type: disc;
            color: var(--text-primary);
        }
        
        .markdown-content ol li {
            list-style-type: decimal;
            color: var(--text-primary);
        }
        
        .markdown-content blockquote {
            background: var(--pastel-teal);
            border-left: 4px solid var(--pastel-indigo);
            padding: 1rem;
            margin: 1.5rem 0;
            border-radius: var(--radius-sm);
            font-style: italic;
        }
        
        .markdown-content code {
            background: var(--pastel-cyan);
            color: var(--text-primary);
            padding: 0.125rem 0.25rem;
            border-radius: var(--radius-sm);
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.875rem;
        }
        
        .markdown-content pre {
            background: var(--pastel-rose);
            padding: 1rem;
            border-radius: var(--radius-md);
            overflow-x: auto;
            margin: 1.5rem 0;
            border: 1px solid var(--border-color);
        }
        
        .markdown-content pre code {
            background: none;
            padding: 0;
            color: var(--text-primary);
        }
        
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        
        .markdown-content th {
            background: var(--pastel-blue);
            color: var(--text-primary);
            font-weight: 600;
            padding: 0.75rem;
            text-align: left;
            border-bottom: 2px solid var(--border-color);
        }
        
        .markdown-content td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .markdown-content tr:hover {
            background: var(--pastel-lime);
        }
        
        .markdown-content a {
            color: var(--accent-color);
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: all 0.2s ease;
        }
        
        .markdown-content a:hover {
            color: var(--primary-color);
            border-bottom-color: var(--accent-color);
        }
        
        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: var(--radius-md);
            margin: 1rem 0;
            box-shadow: var(--shadow-sm);
        }
        
        .markdown-content hr {
            border: none;
            height: 2px;
            background: linear-gradient(to right, var(--pastel-blue), var(--pastel-green), var(--pastel-purple));
            margin: 2rem 0;
            border-radius: var(--radius-sm);
        }
        
        .markdown-content strong {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .markdown-content em {
            font-style: italic;
            color: var(--text-secondary);
        }
        
        /* Enhanced sidebar navigation styling */
        .sidebar-nav {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
        }
        
        .nav-section {
            margin-bottom: 1rem;
        }
        
        .nav-section-header {
            background: var(--pastel-green);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .nav-section-header:hover {
            background: var(--pastel-teal);
            transform: translateX(2px);
        }
        
        .nav-section-header.collapsed {
            background: var(--pastel-yellow);
        }
        
        .nav-item {
            padding: 0.5rem 1rem;
            margin: 0.25rem 0;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }
        
        .nav-item:hover {
            background: var(--pastel-purple);
            transform: translateX(4px);
        }
        
        .nav-item.active {
            background: var(--pastel-blue);
            color: var(--text-primary);
            font-weight: 500;
            border-left: 3px solid var(--accent-color);
        }
        
        .nav-item-icon {
            margin-right: 0.5rem;
            font-size: 1rem;
            color: var(--text-secondary);
        }
        
        .nav-item.active .nav-item-icon {
            color: var(--accent-color);
        }
        
        /* Footer positioning */
        footer {
            margin-top: auto;
            flex-shrink: 0;
            width: 100%;
            position: relative;
            z-index: 10;
        }
        
        /* Ensure footer content doesn't overlap with sidebar */
        footer .container {
            margin-left: 320px;
            max-width: calc(100vw - 320px);
        }
        
        @media (max-width: 1024px) {
            footer .container {
                margin-left: 0;
                max-width: 100vw;
            }
        }
        
        /* Sidebar positioning - will be controlled by JavaScript */
        .sidebar-container {
            transition: all 0.3s ease;
            width: 320px;
        }
        
        .sidebar-container.sticky {
            position: fixed;
            top: var(--header-height);
            left: 0;
            height: calc(100vh - var(--header-height) - var(--footer-height));
            z-index: 30;
            overflow-y: auto;
        }
        
        .sidebar-container.unsticky {
            position: absolute;
            top: var(--header-height);
            left: 0;
            height: auto;
            z-index: 30;
        }
        
        /* Responsive design */
        @media (max-width: 1024px) {
            .sidebar-container {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar-container.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0 !important;
            }
            
            /* Ensure footer stays at bottom on mobile */
            footer {
                margin-top: auto;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            
            .template-title {
                font-size: 1.25rem;
            }
            
            .category-buttons {
                grid-template-columns: 1fr;
            }
            
            .slot-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .slot-label {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .slot-value {
                margin-left: 0;
                width: 100%;
            }
            
            .template-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .template-actions {
                align-self: flex-end;
            }
        }
        
        @media (max-width: 480px) {
            .header .container {
                padding: 0 1rem;
            }
            
            .template-title {
                font-size: 1.125rem;
            }
            
            .category-buttons {
                gap: 0.25rem;
            }
            
            .category-btn {
                padding: 0.375rem 0.5rem;
                font-size: 0.625rem;
            }
            
            .template-item {
                padding: 0.5rem;
            }
            
            .template-name {
                font-size: 0.75rem;
            }
            
            .template-version {
                font-size: 0.625rem;
            }
        }
        
        /* Enhanced animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Loading states */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Chat message prose styling */
        .prose {
            line-height: 1.6;
        }
        
        .prose h1, .prose h2, .prose h3 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .prose p {
            margin-bottom: 1em;
            line-height: 1.6;
        }
        
        .prose ul, .prose ol {
            margin: 1em 0;
            padding-left: 1.5em;
        }
        
        .prose li {
            margin: 0.25em 0;
        }
        
        .prose code {
            background: var(--pastel-cyan);
            padding: 0.125rem 0.25rem;
            border-radius: var(--radius-sm);
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.875em;
        }
        
        .prose pre {
            background: var(--pastel-rose);
            padding: 1rem;
            border-radius: var(--radius-md);
            overflow-x: auto;
            margin: 1em 0;
            border: 1px solid var(--border-color);
        }
        
        .prose pre code {
            background: none;
            padding: 0;
        }
        
        .prose blockquote {
            border-left: 4px solid var(--accent-color);
            padding-left: 1rem;
            margin: 1em 0;
            font-style: italic;
            color: var(--text-secondary);
        }
        
        .prose a {
            color: var(--accent-color);
            text-decoration: underline;
        }
        
        .prose a:hover {
            color: var(--primary-color);
        }
        
        /* Utility classes */
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .ml-1 { margin-left: 0.25rem; }
        .ml-2 { margin-left: 0.5rem; }
        .mr-1 { margin-right: 0.25rem; }
        .mr-2 { margin-right: 0.5rem; }
        .p-1 { padding: 0.25rem; }
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .hidden { display: none; }
        .block { display: block; }
        .inline-block { display: inline-block; }
        .cursor-pointer { cursor: pointer; }
        .transition-all { transition: all 0.2s ease; }
        .rounded { border-radius: var(--radius-md); }
        .rounded-sm { border-radius: var(--radius-sm); }
        .rounded-lg { border-radius: var(--radius-lg); }
        .border { border: 1px solid var(--border-color); }
        .border-b { border-bottom: 1px solid var(--border-color); }
        .border-t { border-top: 1px solid var(--border-color); }
        .shadow-sm { box-shadow: var(--shadow-sm); }
        .shadow-md { box-shadow: var(--shadow-md); }
        .bg-white { background-color: var(--bg-primary); }
        .bg-gray-50 { background-color: var(--bg-secondary); }
        .bg-gray-100 { background-color: var(--bg-tertiary); }
        .text-white { color: white; }
        .text-gray-600 { color: var(--text-secondary); }
        .text-gray-700 { color: var(--text-primary); }
        .text-gray-500 { color: var(--text-muted); }
        
        /* Tab Styles */
        .tab-button {
            transition: all 0.2s ease;
        }
        
        .tab-button.active {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .tab-button:hover {
            color: #3b82f6;
            border-color: #3b82f6;
        }
        
        .tab-content {
            transition: opacity 0.3s ease;
        }
        
        .tab-content.active {
            opacity: 1;
        }
        
        .tab-content.hidden {
            opacity: 0;
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Progress Indicator -->
    <div class="progress-indicator">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    

    
    <!-- Scroll to Top Button -->
    <button id="scrollToTop" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="fixed bottom-6 right-6 bg-blue-800 hover:bg-blue-900 text-white p-3 rounded-full shadow-lg transition-all duration-200 opacity-0 pointer-events-none z-50">
        <span class="material-icons">keyboard_arrow_up</span>
    </button>
    
    <div class="min-h-screen flex flex-col" style="min-height: 100vh;">
        <!-- Header -->
        <header>
            <div class="container">
                <div class="flex items-center justify-between">
                    <!-- Logo and Title - Far Left -->
                    <div class="flex items-center">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iOCIgZmlsbD0iIzNCN0ZGRiIvPgo8cGF0aCBkPSJNMTIgMTJIMjhWMjBIMTJWMjJIMjhWMzBIMTJWMzJIMjBIMjhWMzRIMTJWMzZIMjBIMjhWMzhIMTJWMjBIMTJWMTJaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K" alt="SNOMED CT" class="w-10 h-10 mr-3">
                        <h1 class="text-lg font-semibold text-white">SNOMED CT Editorial Guide</h1>
                    </div>
                    
                    <!-- Search and Actions - Far Right -->
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <input 
                                type="text" 
                                id="searchInput"
                                placeholder="Search... (Ctrl+K)"
                                class="px-3 py-2 rounded-md text-gray-800 w-64 focus:outline-none focus:ring-2 focus:ring-gray-300 text-sm">
                            <span class="material-icons absolute right-2 top-2 text-gray-400 text-sm">search</span>
                            <div id="searchSuggestions" class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-md shadow-lg mt-1 z-40 hidden max-h-60 overflow-y-auto">
                                <!-- Search suggestions will be populated here -->
                            </div>
                        </div>
                        <button id="aiChatButton" class="bg-white/10 hover:bg-white/20 px-3 py-2 rounded-md transition-colors text-white flex items-center space-x-2 text-sm">
                            <span class="material-icons text-sm">smart_toy</span>
                            <span>AI</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Content Area -->
        <div class="flex flex-1" style="min-height: calc(100vh - var(--header-height) - var(--footer-height));">
            <div class="sidebar-container w-80 bg-gray-50 border-r border-gray-200 z-30 sticky">
                <div id="sidebar" class="h-full overflow-y-auto"></div>
            </div>
            <div class="main-content flex-1 ml-80" style="margin-left: 320px;">
                <div class="container mx-auto px-6 py-8 flex-1">
                    <div id="content"></div>
                </div>
            </div>
        </div>

        <!-- AI Chat Modal -->
        <div id="aiChatModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[85vh] flex flex-col">
                    <!-- Chat Header -->
                    <div class="flex items-center justify-between p-6 border-b border-gray-200">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                                <span class="material-icons text-white">smart_toy</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">SNOMED CT AI Assistant</h3>
                                <p class="text-sm text-gray-500">
                                    <span id="aiStatus" class="inline-flex items-center">
                                        <span class="w-2 h-2 rounded-full mr-2" id="aiStatusIndicator"></span>
                                        <span id="aiStatusText">Loading...</span>
                                    </span>
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="aiSettingsButton" class="text-gray-400 hover:text-gray-600 transition-colors p-2 rounded-lg hover:bg-gray-100" title="AI Settings">
                                <span class="material-icons">settings</span>
                            </button>
                            <button id="closeAiChat" class="text-gray-400 hover:text-gray-600 transition-colors">
                                <span class="material-icons text-2xl">close</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Chat Messages -->
                    <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                                <span class="material-icons text-white text-sm">smart_toy</span>
                            </div>
                            <div class="bg-blue-50 rounded-lg p-4 max-w-[85%]">
                                <div class="text-gray-800 prose prose-sm max-w-none">
                                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Hello! I'm your SNOMED CT AI Assistant</h3>
                                    <p class="mb-3">I can help you find information about SNOMED CT editorial guidelines and provide detailed explanations. Here's what I can assist with:</p>
                                    <ul class="list-disc ml-4 my-3 space-y-1">
                                        <li><strong>Editorial guidelines</strong> and best practices</li>
                                        <li><strong>Concept modeling rules</strong> and principles</li>
                                        <li><strong>Naming conventions</strong> and style guides</li>
                                        <li><strong>Domain-specific modeling</strong> for different hierarchies</li>
                                        <li><strong>HRCM tables</strong> and attribute constraints</li>
                                        <li><strong>Implementation guidance</strong> and examples</li>
                                    </ul>
                                    <p class="text-sm text-gray-600 mt-3">Just ask me anything about SNOMED CT! I can provide formatted responses with <code>code examples</code>, <strong>bold text</strong>, and <em>detailed explanations</em>.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Input -->
                    <div class="p-6 border-t border-gray-200">
                        <div class="flex space-x-3">
                            <input 
                                type="text" 
                                id="chatInput"
                                placeholder="Ask about SNOMED CT editorial guidelines..."
                                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                maxlength="500">
                            <button id="sendMessage" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2">
                                <span class="material-icons text-sm">send</span>
                                <span>Send</span>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Powered by AI - Responses are based on the SNOMED CT Editorial Guide content</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Settings Modal -->
        <div id="aiSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl">
                    <!-- Settings Header -->
                    <div class="flex items-center justify-between p-6 border-b border-gray-200">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                                <span class="material-icons text-white">settings</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">AI Assistant Settings</h3>
                                <p class="text-sm text-gray-500">Configure Google Gemini API</p>
                            </div>
                        </div>
                        <button id="closeAiSettings" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <span class="material-icons text-2xl">close</span>
                        </button>
                    </div>
                    
                    <!-- Settings Content -->
                    <div class="p-6 space-y-6">
                        <!-- API Key Configuration -->
                        <div>
                            <label for="geminiApiKey" class="block text-sm font-medium text-gray-700 mb-2">
                                Google Gemini API Key
                            </label>
                            <div class="flex space-x-2">
                                <input 
                                    type="password" 
                                    id="geminiApiKey"
                                    placeholder="Enter your Gemini API key..."
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    value="">
                                <button id="toggleApiKeyVisibility" class="px-3 py-2 text-gray-500 hover:text-gray-700">
                                    <span class="material-icons">visibility</span>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                Get your free API key from 
                                <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-600 hover:text-blue-800 underline">
                                    Google AI Studio
                                </a>
                            </p>
                        </div>

                        <!-- API Status -->
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-2">API Status</h4>
                            <div id="apiStatusDisplay" class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
                                <span class="w-3 h-3 rounded-full bg-gray-400" id="apiStatusIndicator"></span>
                                <span class="text-sm text-gray-600" id="apiStatusText">Not configured</span>
                            </div>
                        </div>

                        <!-- Usage Information -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="text-sm font-medium text-blue-800 mb-2">Free Tier Information</h4>
                            <ul class="text-xs text-blue-700 space-y-1">
                                <li>‚Ä¢ 15 requests per minute</li>
                                <li>‚Ä¢ 2M characters per minute</li>
                                <li>‚Ä¢ No credit card required</li>
                                <li>‚Ä¢ Responses are cached to reduce usage</li>
                            </ul>
                        </div>

                        <!-- Cache Management -->
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Response Cache</h4>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600" id="cacheInfo">0 cached responses</span>
                                <button id="clearCache" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors">
                                    Clear Cache
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Settings Footer -->
                    <div class="flex items-center justify-end space-x-3 p-6 border-t border-gray-200">
                        <button id="cancelAiSettings" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                            Cancel
                        </button>
                        <button id="saveAiSettings" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-gray-900 text-white">
            <div class="container mx-auto px-6 py-8">
                <div class="grid md:grid-cols-4 gap-8">
                    <div class="md:col-span-2">
                        <div class="flex items-center mb-4">
                            <span class="material-icons text-2xl mr-2">medical_services</span>
                            <h4 class="font-semibold text-lg">SNOMED CT Editorial Guide</h4>
                        </div>
                        <p class="text-gray-300 text-sm mb-4">Interactive browser for the comprehensive SNOMED CT Editorial Guide, providing guidelines for clinical terminology management. This tool helps implementers and clinicians navigate the complex world of SNOMED CT terminology standards.</p>
                        <div class="flex items-center space-x-4">
                            <a href="https://www.snomed.org/" target="_blank" class="text-blue-300 hover:text-white text-sm flex items-center">
                                <span class="material-icons text-sm mr-1">open_in_new</span>
                                SNOMED International
                            </a>
                            <a href="https://confluence.ihtsdotools.org/display/DOCEG/PDFs+for+Download" target="_blank" class="text-blue-300 hover:text-white text-sm flex items-center">
                                <span class="material-icons text-sm mr-1">description</span>
                                PDF Downloads
                            </a>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-4">Resources</h4>
                        <ul class="space-y-2 text-sm text-gray-300">
                            <li><a href="https://www.snomed.org/snomed-ct" target="_blank" class="hover:text-white flex items-center">
                                <span class="material-icons text-xs mr-1">info</span>
                                What is SNOMED CT?
                            </a></li>
                            <li><a href="https://www.snomed.org/snomed-ct/get-snomed-ct" target="_blank" class="hover:text-white flex items-center">
                                <span class="material-icons text-xs mr-1">download</span>
                                Get SNOMED CT
                            </a></li>
                            <li><a href="https://www.snomed.org/snomed-ct/use-snomed-ct" target="_blank" class="hover:text-white flex items-center">
                                <span class="material-icons text-xs mr-1">settings</span>
                                Use SNOMED CT
                            </a></li>
                            <li><a href="https://www.snomed.org/snomed-ct/education" target="_blank" class="hover:text-white flex items-center">
                                <span class="material-icons text-xs mr-1">school</span>
                                Education
                            </a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-4">Version Info</h4>
                        <p class="text-gray-300 text-sm">Current Guide: 2025-01-08</p>
                        <p class="text-gray-300 text-sm">Monthly updates available</p>
                        <p class="text-gray-300 text-sm">¬© 2025 SNOMED International</p>
                        <div class="mt-4 pt-4 border-t border-gray-700">
                            <p class="text-gray-400 text-xs">Registered in England and Wales</p>
                            <p class="text-gray-400 text-xs">Company Registration Number 9915820</p>
                            <p class="text-gray-400 text-xs mt-2">Statistics from SNOMED CT Release (July 2025)</p>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Simple vanilla JavaScript implementation for the SNOMED CT Editorial Guide
        
        // Data storage - Dynamic content loaded from markdown files in /output
        const guideData = {
            sections: [],
            hierarchicalSections: [], // Maintains hierarchical order for navigation
            currentSection: 'introduction',
            searchResults: []
        };

        // Concept ID to section mapping for cross-references
        const conceptMap = {
            '138875005': 'concept-model',
            '123037004': 'body-structure',
            '404684003': 'clinical-finding',
            '71388002': 'procedure',
            '373873005': 'pharmaceutical',
            '363787002': 'observable-entity',
            '410607006': 'organism',
            '105590001': 'substance',
            '48176007': 'situation-context',
            '123038009': 'specimen',
            '57054005': 'clinical-finding',
            '80146002': 'procedure',
            '27658006': 'pharmaceutical',
            '96367001': 'pharmaceutical',
            '112283007': 'organism',
            '840539006': 'organism'
        };

        // SNOMED CT Release Statistics (July 2025) - Updated from Google Sheets
        const snomedStats = {
            totalActive: 374846,
            totalConcepts: 524399,
            hierarchies: [
                { id: '123037004', name: 'Body structure (body structure)', semTag: '(body structure)', active: 42775, total: 47968, new: 29, changed: 0, inactivated: 6, reactivated: 0, newSD: 2, newP: 27 },
                { id: '404684003', name: 'Clinical finding (finding)', semTag: '(finding)', active: 126809, total: 184236, new: 656, changed: 39, inactivated: 41, reactivated: 1, newSD: 555, newP: 101 },
                { id: '308916002', name: 'Environment or geographical location (environment / location)', semTag: '(environment / location)', active: 1876, total: 2117, new: 1, changed: 0, inactivated: 0, reactivated: 0, newSD: 0, newP: 1 },
                { id: '272379006', name: 'Event (event)', semTag: '(event)', active: 3315, total: 8519, new: 1, changed: 0, inactivated: 0, reactivated: 0, newSD: 0, newP: 1 },
                { id: '363787002', name: 'Observable entity (observable entity)', semTag: '(observable entity)', active: 10950, total: 12235, new: 6, changed: 0, inactivated: 2, reactivated: 0, newSD: 1, newP: 5 },
                { id: '410607006', name: 'Organism (organism)', semTag: '(organism)', active: 34495, total: 41880, new: 48, changed: 0, inactivated: 2, reactivated: 0, newSD: 0, newP: 48 },
                { id: '373873005', name: 'Pharmaceutical / biologic product (product)', semTag: '(product)', active: 25695, total: 43316, new: 3, changed: 0, inactivated: 9, reactivated: 0, newSD: 3, newP: 0 },
                { id: '78621006', name: 'Physical force (physical force)', semTag: '(physical force)', active: 172, total: 182, new: 0, changed: 0, inactivated: 0, reactivated: 0, newSD: 0, newP: 0 },
                { id: '260787004', name: 'Physical object (physical object)', semTag: '(physical object)', active: 14006, total: 17810, new: 10, changed: 0, inactivated: 0, reactivated: 0, newSD: 0, newP: 10 },
                { id: '71388002', name: 'Procedure (procedure)', semTag: '(procedure)', active: 59650, total: 90916, new: 94, changed: 34, inactivated: 45, reactivated: 0, newSD: 70, newP: 24 },
                { id: '362981000', name: 'Qualifier value (qualifier value)', semTag: '(qualifier value)', active: 12191, total: 15018, new: 18, changed: 1, inactivated: 0, reactivated: 0, newSD: 0, newP: 18 },
                { id: '419891008', name: 'Record artifact (record artifact)', semTag: '(record artifact)', active: 520, total: 702, new: 0, changed: 0, inactivated: 0, reactivated: 0, newSD: 0, newP: 0 },
                { id: '138875005', name: 'SNOMED CT Concept (SNOMED RT+CTV3)', semTag: '(SNOMED RT+CTV3)', active: 1, total: 9, new: 0, changed: 0, inactivated: 0, reactivated: 0, newSD: 0, newP: 0 },
                { id: '900000000000441003', name: 'SNOMED CT Model Component (metadata)', semTag: '(metadata)', active: 1900, total: 1964, new: 2, changed: 0, inactivated: 0, reactivated: 0, newSD: 0, newP: 2 },
                { id: '243796009', name: 'Situation with explicit context (situation)', semTag: '(situation)', active: 5053, total: 11828, new: 2, changed: 0, inactivated: 1, reactivated: 0, newSD: 1, newP: 1 },
                { id: '48176007', name: 'Social context (social concept)', semTag: '(social concept)', active: 4180, total: 7996, new: 2, changed: 0, inactivated: 1, reactivated: 0, newSD: 0, newP: 2 },
                { id: '370115009', name: 'Special concept (special concept)', semTag: '(special concept)', active: 2, total: 1965, new: 0, changed: 0, inactivated: 616, reactivated: 0, newSD: 0, newP: 0 },
                { id: '123038009', name: 'Specimen (specimen)', semTag: '(specimen)', active: 1823, total: 1972, new: 2, changed: 0, inactivated: 1, reactivated: 0, newSD: 2, newP: 0 },
                { id: '254291000', name: 'Staging and scales (staging scale)', semTag: '(staging scale)', active: 1665, total: 1911, new: 2, changed: 0, inactivated: 0, reactivated: 0, newSD: 0, newP: 2 },
                { id: '105590001', name: 'Substance (substance)', semTag: '(substance)', active: 27768, total: 31650, new: 21, changed: 0, inactivated: 0, reactivated: 0, newSD: 0, newP: 21 }
            ],
            summary: {
                totalNew: 897,
                totalChanged: 74,
                totalInactivated: 724,
                totalReactivated: 1,
                newSD: 634,
                newP: 263
            }
        };

        // Cross-reference data
        const crossReferences = {
            'introduction': ['concept-model', 'authoring-philosophy'],
            'concept-model': ['body-structure', 'clinical-finding', 'procedure'],
            'clinical-finding': ['body-structure', 'organism', 'procedure'],
            'procedure': ['clinical-finding', 'body-structure', 'pharmaceutical'],
            'pharmaceutical': ['substance', 'clinical-finding'],
            'body-structure': ['clinical-finding', 'procedure'],
            'organism': ['clinical-finding', 'substance'],
            'substance': ['pharmaceutical', 'organism'],
            'situation-context': ['clinical-finding', 'procedure'],
            'specimen': ['observable-entity', 'substance']
        };

        // Application state and methods
        const app = {
            currentCollapsedSections: new Set(),
            loadedSections: new Set(), // Track which sections are currently loaded in DOM
            visibleSections: new Set(), // Track which sections are currently visible
            sectionElements: new Map(), // Map section IDs to their DOM elements
            observer: null, // Intersection Observer for scroll detection
            isLoading: false, // Prevent multiple simultaneous loads
            preloadDistance: 1000, // Distance in pixels to preload content
            
            // URL handling for direct section linking
            initializeURLHandling() {
                // Handle browser back/forward navigation
                window.addEventListener('popstate', (event) => {
                    this.handleURLChange();
                });
                
                // Update URL when sections change
                this.updateURL = this.debounce(this.updateURL.bind(this), 100);
            },
            
            handleURLOnLoad() {
                const urlParams = new URLSearchParams(window.location.search);
                const sectionParam = urlParams.get('section');
                const hash = window.location.hash.replace('#', '');
                
                let targetSection = sectionParam || hash || 'landing';
                
                // Clean up the section ID (remove any extra characters)
                targetSection = targetSection.trim();
                
                console.log('üîó URL Load Analysis:', {
                    sectionParam,
                    hash,
                    targetSection,
                    sectionsLoaded: guideData.sections.length,
                    availableSections: guideData.sections.map(s => s.id).slice(0, 5)
                });
                
                // Validate section exists
                if (targetSection !== 'landing' && !guideData.sections.find(s => s.id === targetSection)) {
                    console.warn(`Section "${targetSection}" not found in available sections. Available sections:`, 
                        guideData.sections.map(s => s.id));
                    targetSection = 'landing';
                }
                
                // Ensure sections are loaded before proceeding
                if (guideData.sections.length === 0) {
                    console.log('‚è≥ No sections loaded yet, waiting...');
                    const checkSections = () => {
                        if (guideData.sections.length > 0) {
                            console.log(`‚úÖ Sections loaded (${guideData.sections.length}), selecting: ${targetSection}`);
                            this.selectSection(targetSection);
                        } else {
                            console.log('‚è≥ Still waiting for sections...');
                            setTimeout(checkSections, 100);
                        }
                    };
                    checkSections();
                } else {
                    console.log(`‚úÖ Sections ready (${guideData.sections.length}), selecting: ${targetSection}`);
                    this.selectSection(targetSection);
                }
            },
            
            handleURLChange() {
                const urlParams = new URLSearchParams(window.location.search);
                const sectionParam = urlParams.get('section');
                const hash = window.location.hash.replace('#', '');
                
                let targetSection = sectionParam || hash || 'landing';
                
                // Clean up the section ID
                targetSection = targetSection.trim();
                
                // Validate section exists
                if (targetSection !== 'landing' && !guideData.sections.find(s => s.id === targetSection)) {
                    console.warn(`Section "${targetSection}" not found during URL change, defaulting to landing`);
                    targetSection = 'landing';
                }
                
                this.selectSection(targetSection);
            },
            
                        updateURL(sectionId) {
                const url = new URL(window.location);
                
                if (sectionId === 'landing') {
                    url.searchParams.delete('section');
                    url.hash = '';
                } else {
                    url.searchParams.set('section', sectionId);
                    url.hash = sectionId;
                }
                
                // Only update if URL actually changed
                const newURL = url.toString();
                
                if (newURL !== window.location.href) {
                    window.history.pushState({ section: sectionId }, '', url);
                    
                    // Update page title for better UX
                    const section = guideData.sections.find(s => s.id === sectionId);
                    if (section) {
                        document.title = `${section.title} - SNOMED CT Editorial Guide`;
                    } else if (sectionId === 'landing') {
                        document.title = 'SNOMED CT Editorial Guide';
                    }
                    
                    // Update meta description for SEO
                    const metaDescription = document.querySelector('meta[name="description"]');
                    if (metaDescription && section) {
                        metaDescription.setAttribute('content', 
                            `SNOMED CT Editorial Guide - ${section.title}. ${section.description || 'Comprehensive guidelines for clinical terminology management.'}`);
                    }
                }
            },
            
            // Copy current section link to clipboard
            copyCurrentSectionLink() {
                const currentURL = window.location.href;
                navigator.clipboard.writeText(currentURL).then(() => {
                    // Show success feedback
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-20 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
                    notification.innerHTML = `
                        <div class="flex items-center">
                            <span class="material-icons text-sm mr-2">content_copy</span>
                            <span class="text-sm">Link copied to clipboard!</span>
                        </div>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    // Animate in
                    setTimeout(() => {
                        notification.classList.remove('translate-x-full');
                    }, 100);
                    
                    // Remove after 3 seconds
                    setTimeout(() => {
                        notification.classList.add('translate-x-full');
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.parentNode.removeChild(notification);
                            }
                        }, 300);
                    }, 3000);
                }).catch(err => {
                    console.error('Failed to copy link:', err);
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = currentURL;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                });
            },
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            // HRCM sections mapping - sections that should use dynamic MRCM data instead of static markdown
            getHRCMSectionMapping() {
                return {
                    'clinical-finding-attributes-summary': { domainId: '404684003', domainName: 'Clinical finding (finding)' },
                    'body-structure-attributes-summary': { domainId: '123037004', domainName: 'Body structure (body structure)' },
                    'procedure-attributes-summary': { domainId: '71388002', domainName: 'Procedure (procedure)' },
                    'observable-entity-attributes-summary': { domainId: '363787002', domainName: 'Observable entity (observable entity)' },
                    'pharmaceutical-and-biologic-product-and-dose-form-attributes-summary': { domainId: '373873005', domainName: 'Pharmaceutical / biologic product (product)' },
                    'physical-object-attributes-summary': { domainId: '260787004', domainName: 'Physical object (physical object)' },
                    'situation-with-explicit-context-attributes-summary': { domainId: '243796009', domainName: 'Situation with explicit context (situation)' },
                    'specimen-attributes-summary': { domainId: '123038009', domainName: 'Specimen (specimen)' },
                    'substance-attribute-summary': { domainId: '105590001', domainName: 'Substance (substance)' },
                    'event-attributes-summary': { domainId: '272379006', domainName: 'Event (event)' }
                };
            },

            isHRCMSection(sectionId) {
                const hrcmMapping = this.getHRCMSectionMapping();
                const result = hrcmMapping.hasOwnProperty(sectionId);
                // Debug specific cases
                if (sectionId && sectionId.includes('attributes-summary')) {
                    console.log('üìä HRCM section detected:', sectionId, 'isHRCM:', result, 'mapping has key:', Object.keys(hrcmMapping).includes(sectionId));
                }
                return result;
            },
























            










            // Debug navigation structure


            async renderHRCMTable(sectionId, sectionTitle) {
                const hrcmMapping = this.getHRCMSectionMapping();
                const domainInfo = hrcmMapping[sectionId];
                
                if (!domainInfo) {
                    return `<p class="text-red-600">No HRCM mapping found for section: ${sectionId}</p>`;
                }

                try {
                    const hrcmData = await mrcmService.getHRCMData(domainInfo.domainId, domainInfo.domainName);
                    
                                         if (!hrcmData || !hrcmData.attributes) {
                         return `
                             <div class="space-y-4">
                                 <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                                     <div class="flex items-start">
                                         <span class="material-icons text-yellow-600 mr-3 mt-1">warning</span>
                                         <div>
                                             <p class="text-yellow-800 font-semibold mb-2">Unable to load live HRCM data</p>
                                             <p class="text-yellow-700 text-sm mb-3">Could not fetch live MRCM data for ${domainInfo.domainName}. This may be due to:</p>
                                             <ul class="text-yellow-700 text-sm space-y-1 ml-4 list-disc">
                                                 <li>No connection to the terminology server</li>
                                                 <li>Server maintenance or downtime</li>
                                                 <li>MRCM refsets not available for this domain</li>
                                             </ul>
                                             <p class="text-yellow-700 text-sm mt-3">Try refreshing or check the server configuration.</p>
                                         </div>
                                     </div>
                                 </div>
                                 
                                 <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                                     <h4 class="text-lg font-semibold text-blue-800 mb-3">About HRCM Tables</h4>
                                     <p class="text-blue-700 text-sm mb-3">
                                         Human Readable Concept Model (HRCM) tables show the approved attributes and allowable ranges 
                                         for authoring concepts in the <strong>${domainInfo.domainName}</strong> domain. 
                                         This data comes directly from SNOMED CT MRCM refsets (723561005).
                                     </p>
                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                         <div>
                                             <p class="font-medium text-blue-800 mb-1">Table Columns:</p>
                                             <ul class="text-blue-700 space-y-1">
                                                 <li>‚Ä¢ <strong>Attribute:</strong> SNOMED CT attribute concept</li>
                                                 <li>‚Ä¢ <strong>Grouped:</strong> Whether attribute must be in a role group</li>
                                                 <li>‚Ä¢ <strong>Cardinality:</strong> Number of times attribute can appear</li>
                                             </ul>
                                         </div>
                                         <div>
                                             <p class="font-medium text-blue-800 mb-1">Additional Info:</p>
                                             <ul class="text-blue-700 space-y-1">
                                                 <li>‚Ä¢ <strong>In Group Cardinality:</strong> Occurrences within role group</li>
                                                 <li>‚Ä¢ <strong>Range Constraint:</strong> Allowed values for attribute</li>
                                                 <li>‚Ä¢ Data is live from MRCM refsets</li>
                                             </ul>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         `;
                     }

                    // Generate the HRCM table HTML
                    return this.generateHRCMTableHTML(hrcmData, domainInfo, sectionId);
                    
                } catch (error) {
                    console.error('Error rendering HRCM table:', error);
                    return `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <span class="material-icons text-red-600 mr-2">error</span>
                                <div>
                                    <p class="text-red-800 font-semibold">Error loading HRCM data</p>
                                    <p class="text-red-700 text-sm mt-1">${error.message}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            },

            generateHRCMTableHTML(hrcmData, domainInfo, sectionId) {
                const attributesHTML = hrcmData.attributes.map(attr => `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3 border-b border-gray-200">
                            <div class="flex items-center">
                                <span class="concept-id" data-concept-id="${attr.id}" title="SNOMED CT Concept: ${attr.name}">${attr.id}</span>
                                <span class="ml-2 font-medium text-blue-800">|${attr.name}|</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 border-b border-gray-200 text-center">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${attr.grouped === '1' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${attr.grouped === '1' ? 'Yes' : 'No'}
                            </span>
                        </td>
                        <td class="px-4 py-3 border-b border-gray-200 text-center font-mono text-sm">${attr.cardinality}</td>
                        <td class="px-4 py-3 border-b border-gray-200 text-center font-mono text-sm">${attr.inGroupCardinality}</td>
                        <td class="px-4 py-3 border-b border-gray-200">
                            <div class="text-sm text-gray-700 font-mono break-words">${attr.range}</div>
                        </td>
                    </tr>
                `).join('');

                return `
                    <div class="space-y-6">
                        <!-- HRCM Header Information -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                            <div class="flex items-start justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-blue-900 mb-2">${hrcmData.title}</h3>
                                    <p class="text-blue-700 text-sm mb-4">${hrcmData.description}</p>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex items-center">
                                            <span class="font-medium text-blue-800 w-32">Domain:</span>
                                            <span class="font-mono text-blue-700">${hrcmData.domainConstraint}</span>
                                        </div>
                                        <div class="flex items-center">
                                            <span class="font-medium text-blue-800 w-32">Version:</span>
                                            <span class="text-blue-700">${hrcmData.version}</span>
                                        </div>
                                        <div class="flex items-center">
                                            <span class="font-medium text-blue-800 w-32">Last Updated:</span>
                                            <span class="text-blue-700">${new Date(hrcmData.serverInfo.lastFetched).toLocaleString()}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="bg-white rounded-lg p-3 border border-blue-200">
                                        <div class="text-2xl font-bold text-blue-800">${hrcmData.attributes.length}</div>
                                        <div class="text-xs text-blue-600 uppercase tracking-wide">Attributes</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- HRCM Attributes Table -->
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                                <h4 class="text-lg font-semibold text-gray-800">Attribute Constraints for ${domainInfo.domainName}</h4>
                                <p class="text-sm text-gray-600 mt-1">Live data from SNOMED CT MRCM refsets</p>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead class="bg-blue-600 text-white">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wide">Attribute</th>
                                            <th class="px-4 py-3 text-center text-sm font-semibold uppercase tracking-wide">Grouped</th>
                                            <th class="px-4 py-3 text-center text-sm font-semibold uppercase tracking-wide">Cardinality</th>
                                            <th class="px-4 py-3 text-center text-sm font-semibold uppercase tracking-wide">In Group Cardinality</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wide">Range Constraint</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${attributesHTML}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Server Information -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex items-center text-sm text-gray-600">
                                <span class="material-icons text-gray-500 mr-2 text-base">info</span>
                                <span>Data source: </span>
                                <a href="${hrcmData.sourceUrl}" target="_blank" class="ml-1 text-blue-600 hover:text-blue-800 underline">
                                    ${hrcmData.serverInfo.baseUrl} (${hrcmData.serverInfo.branch})
                                </a>
                                <button onclick="app.refreshHRCMSection('${sectionId}')" 
                                        class="ml-4 px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors">
                                    <span class="material-icons text-sm mr-1">refresh</span>
                                    Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            enhanceMarkdownContent(html) {
                // Prefix relative image URLs so they resolve correctly from root page
                html = html.replace(/src="images\//g, 'src="output/images/');
                
                // Enhanced SNOMED CT concept ID detection and styling
                html = html.replace(/(\d{6,18})\s*\|([^|]+)\|/g, 
                    '<span class="concept-id" data-concept-id="$1" title="SNOMED CT Concept: $2">$1</span> |$2|'
                );
                
                // Style pipe-delimited SNOMED CT terms with enhanced styling
                html = html.replace(/\|([^|]+)\|/g, '<span class="snomed-term">|$1|</span>');
                
                // Enhance figure captions with modern styling
                html = html.replace(/<figcaption>/g, '<figcaption class="enhanced-caption">');
                
                // Add responsive classes and modern styling to images
                html = html.replace(/<img/g, '<img class="enhanced-image"');
                
                // Enhance tables with better styling and responsive wrapper
                html = html.replace(/<table>/g, '<div class="table-wrapper"><table class="enhanced-table">');
                html = html.replace(/<\/table>/g, '</table></div>');
                
                // Add icons and enhanced styling to external links
                html = html.replace(/<a\s+href="http/g, '<a class="external-link" href="http');
                html = html.replace(/(<a[^>]*href="http[^"]*"[^>]*>)([^<]*)</g, 
                    '$1$2<span class="material-icons external-icon">open_in_new</span><'
                );
                
                // Enhance code blocks with syntax highlighting indicators
                html = html.replace(/<pre><code>/g, '<pre class="enhanced-code"><code>');
                
                // Add enhanced styling to blockquotes
                html = html.replace(/<blockquote>/g, '<blockquote class="enhanced-blockquote">');
                
                // Enhance lists with better styling
                html = html.replace(/<ul>/g, '<ul class="enhanced-list">');
                html = html.replace(/<ol>/g, '<ol class="enhanced-list">');
                
                // Add enhanced styling to headings
                html = html.replace(/<h1>/g, '<h1 class="enhanced-heading">');
                html = html.replace(/<h2>/g, '<h2 class="enhanced-heading">');
                html = html.replace(/<h3>/g, '<h3 class="enhanced-heading">');
                
                return html;
            },

            injectStatisticsIntoContent(html, sectionId) {
                // Inject hierarchy statistics for relevant sections
                const hierarchyMappings = {
                    'clinical-finding': '404684003',
                    'body-structure': '123037004',
                    'procedure': '71388002',
                    'observable-entity': '363787002',
                    'pharmaceutical': '373873005',
                    'organism': '410607006',
                    'substance': '105590001',
                    'specimen': '123038009',
                    'event': '272379006',
                    'situation': '243796009'
                };
                
                // Check if this section is related to a specific hierarchy
                for (const [key, hierarchyId] of Object.entries(hierarchyMappings)) {
                    if (sectionId.includes(key)) {
                        const statsHTML = this.generateHierarchyStats(hierarchyId);
                        if (statsHTML) {
                            // Insert stats after the first h1 or h2 heading
                            const headingMatch = html.match(/<h[12][^>]*>.*?<\/h[12]>/);
                            if (headingMatch) {
                                const insertIndex = html.indexOf(headingMatch[0]) + headingMatch[0].length;
                                html = html.slice(0, insertIndex) + statsHTML + html.slice(insertIndex);
                            } else {
                                // If no heading found, insert at the beginning
                                html = statsHTML + html;
                            }
                        }
                        break;
                    }
                }
                
                return html;
            },
            
            refreshHRCMSection(sectionId) {
                // Re-render the current section if it's an HRCM section
                if (this.isHRCMSection(sectionId) && guideData.currentSection === sectionId) {
                    this.renderContent();
                }
            },


            
            init() {
                console.log('üöÄ Initializing application...');
                console.log(`üìä Sections loaded: ${guideData.sections.length}`);
                
                // Initialize AI services
                this.initializeAiServices();
                
                // Render sidebar after sections are loaded
                this.renderSidebar();
                
                this.initializeURLHandling(); // Initialize URL handling first
                this.renderContent(); // Render initial content
                this.setupEventListeners();
                this.setupProgressBar();
                this.setupKeyboardShortcuts();
                this.setupSidebarScrollBehavior();
                
                // Application initialized successfully
                console.log('Application initialized with', guideData.sections.length, 'sections');
            },

            initializeAiServices() {
                // Load API key from localStorage
                const savedApiKey = localStorage.getItem('geminiApiKey');
                if (savedApiKey && geminiService) {
                    geminiService.apiKey = savedApiKey;
                    geminiService.isAvailable = true;
                    if (config) {
                        config.gemini.apiKey = savedApiKey;
                    }
                }
                
                // Update AI status display
                setTimeout(() => {
                    this.updateAiStatus();
                }, 100);
            },



            renderSidebar() {
                console.log('üé® Rendering sidebar...');
                console.log(`üìä Hierarchy available: ${!!guideData.hierarchy}`);
                console.log(`üìä Hierarchy length: ${guideData.hierarchy ? guideData.hierarchy.length : 0}`);
                console.log(`üìä Sections available: ${guideData.sections.length}`);
                
                const sidebar = document.getElementById('sidebar');
                
                // Render hierarchical structure if available
                if (guideData.hierarchy && guideData.hierarchy.length > 0) {
                    const hierarchyHTML = this.renderHierarchyLevel(guideData.hierarchy, 0);
                    
                    sidebar.innerHTML = `
                        <nav class="sidebar-nav">
                            <div class="sticky top-0 bg-gray-50 p-4 border-b border-gray-200 z-10">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-semibold text-gray-800">SNOMED CT Editorial Guide</h3>
                                    <button onclick="app.showLandingPage()" 
                                            class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-50 transition-colors"
                                            title="Return to Home">
                                        <span class="material-icons text-lg">home</span>
                                    </button>
                                </div>
                            </div>
                            <div class="hierarchy-container p-4">
                                ${hierarchyHTML}
                            </div>
                            
                            <div class="mt-4 p-4 bg-white border-t border-gray-200">
                                <h4 class="font-semibold text-gray-800 mb-2">Quick Links</h4>
                                <ul class="space-y-2 text-sm">
                                    <li><button onclick="app.showLandingPage()" 
                                          class="text-blue-600 hover:underline flex items-center w-full text-left">
                                        <span class="material-icons text-sm mr-1">home</span>
                                        Home (with Statistics)
                                    </button></li>
                                    <li><a href="https://confluence.ihtsdotools.org/display/DOCEG/PDFs+for+Download" 
                                          target="_blank" 
                                          class="text-blue-600 hover:underline flex items-center">
                                        <span class="material-icons text-sm mr-1">download</span>
                                        PDF Downloads
                                    </a></li>
                                    <li><a href="https://confluence.ihtsdotools.org/display/DOCEG/SNOMED+CT+Editorial+Guide" 
                                          target="_blank" 
                                          class="text-blue-600 hover:underline flex items-center">
                                        <span class="material-icons text-sm mr-1">link</span>
                                        Official Guide
                                    </a></li>
                                </ul>
                            </div>
                        </nav>
                    `;
                } else {
                    // Fallback to flat structure
                const sectionsHTML = guideData.sections.map(section => {
                    const sectionIcon = this.getSectionIcon(section.id, section.title, 0);
                    return `
                        <li class="cursor-pointer p-3 rounded-lg transition-colors hover:bg-blue-50 section-item ${guideData.currentSection === section.id ? 'bg-blue-100' : ''}" 
                            data-section="${section.id}">
                            <div class="flex items-center space-x-3">
                                <span class="material-icons text-blue-600">${sectionIcon}</span>
                                <div>
                                    <div class="font-medium text-gray-800">${section.title}</div>
                                    <div class="text-sm text-gray-500">${section.description}</div>
                                </div>
                            </div>
                        </li>
                    `;
                }).join('');

                sidebar.innerHTML = `
                        <nav class="sidebar-nav">
                            <div class="sticky top-0 bg-gray-50 p-4 border-b border-gray-200 z-10">
                                <h3 class="text-lg font-semibold text-gray-800">Guide Sections</h3>
                            </div>
                            <div class="p-4">
                        <ul class="space-y-2">
                            ${sectionsHTML}
                            </ul>
                        </div>
                    </nav>
                `;
                }
            },

            getSectionIcon(sectionId, title, level = 0) {
                // Main section icons
                if (sectionId.startsWith('01-')) return 'info';
                if (sectionId.startsWith('02-')) return 'schema';
                if (sectionId.startsWith('03-')) return 'edit';
                if (sectionId.startsWith('04-')) return 'style';
                if (sectionId.startsWith('05-')) return 'download';
                if (sectionId.startsWith('99-')) return 'help';
                
                // Subsection icons based on content
                const lowerTitle = title.toLowerCase();
                if (lowerTitle.includes('introduction') || lowerTitle.includes('overview')) return 'info';
                if (lowerTitle.includes('concept') || lowerTitle.includes('model')) return 'schema';
                if (lowerTitle.includes('authoring') || lowerTitle.includes('writing')) return 'edit';
                if (lowerTitle.includes('style') || lowerTitle.includes('format')) return 'style';
                if (lowerTitle.includes('download') || lowerTitle.includes('pdf')) return 'download';
                if (lowerTitle.includes('body') || lowerTitle.includes('anatomy')) return 'accessibility';
                if (lowerTitle.includes('clinical') || lowerTitle.includes('finding')) return 'healing';
                if (lowerTitle.includes('procedure') || lowerTitle.includes('surgery')) return 'medical_services';
                if (lowerTitle.includes('pharmaceutical') || lowerTitle.includes('drug')) return 'medication';
                if (lowerTitle.includes('organism') || lowerTitle.includes('bacteria')) return 'biotech';
                if (lowerTitle.includes('substance') || lowerTitle.includes('chemical')) return 'science';
                if (lowerTitle.includes('observable') || lowerTitle.includes('measurement')) return 'monitor_heart';
                if (lowerTitle.includes('specimen') || lowerTitle.includes('sample')) return 'biotech';
                if (lowerTitle.includes('situation') || lowerTitle.includes('context')) return 'psychology';
                if (lowerTitle.includes('physical') || lowerTitle.includes('object')) return 'inventory';
                if (lowerTitle.includes('environment') || lowerTitle.includes('location')) return 'location_on';
                if (lowerTitle.includes('event') || lowerTitle.includes('occurrence')) return 'event';
                if (lowerTitle.includes('naming') || lowerTitle.includes('convention')) return 'text_fields';
                if (lowerTitle.includes('scope') || lowerTitle.includes('boundary')) return 'crop_square';
                if (lowerTitle.includes('general') || lowerTitle.includes('basic')) return 'settings';
                if (lowerTitle.includes('domain') || lowerTitle.includes('specific')) return 'category';
                if (lowerTitle.includes('modeling') || lowerTitle.includes('structure')) return 'account_tree';
                if (lowerTitle.includes('requirements') || lowerTitle.includes('specification')) return 'rule';
                if (lowerTitle.includes('coverage') || lowerTitle.includes('range')) return 'coverage';
                if (lowerTitle.includes('knowledge') || lowerTitle.includes('representation')) return 'psychology';
                if (lowerTitle.includes('electronic') || lowerTitle.includes('health')) return 'computer';
                if (lowerTitle.includes('implementation') || lowerTitle.includes('migration')) return 'system_update';
                if (lowerTitle.includes('user') || lowerTitle.includes('community')) return 'group';
                if (lowerTitle.includes('out') || lowerTitle.includes('scope')) return 'block';
                if (lowerTitle.includes('summary') || lowerTitle.includes('overview')) return 'summarize';
                if (lowerTitle.includes('attributes') || lowerTitle.includes('characteristics')) return 'tune';
                if (lowerTitle.includes('root') || lowerTitle.includes('top')) return 'account_tree';
                if (lowerTitle.includes('component') || lowerTitle.includes('part')) return 'widgets';
                if (lowerTitle.includes('qualifying') || lowerTitle.includes('modifier')) return 'adjust';
                if (lowerTitle.includes('defining') || lowerTitle.includes('essential')) return 'check_circle';
                if (lowerTitle.includes('changes') || lowerTitle.includes('modification')) return 'edit';
                if (lowerTitle.includes('inactivation') || lowerTitle.includes('retirement')) return 'archive';
                if (lowerTitle.includes('annotation') || lowerTitle.includes('note')) return 'note';
                if (lowerTitle.includes('case') || lowerTitle.includes('sensitivity')) return 'text_fields';
                if (lowerTitle.includes('definition') || lowerTitle.includes('meaning')) return 'description';
                if (lowerTitle.includes('action') || lowerTitle.includes('verb')) return 'play_arrow';
                if (lowerTitle.includes('proprietary') || lowerTitle.includes('trademark')) return 'copyright';
                if (lowerTitle.includes('adjudication') || lowerTitle.includes('decision')) return 'gavel';
                if (lowerTitle.includes('content') || lowerTitle.includes('request')) return 'content_paste';
                
                // Default icons for different levels
                return level === 0 ? 'folder' : 'article';
            },

            renderHierarchyLevel(items, level) {
                return items.map(item => {
                    const indent = level * 16; // 16px per level
                    const isExpanded = this.isExpanded(item.id);
                    const hasSubcategories = item.subcategories && item.subcategories.length > 0;
                    const hasFiles = item.files && item.files.length > 0;
                    const sectionIcon = this.getSectionIcon(item.id, item.title, level);
                    
                    let categoryHTML = '';
                    if (level === 0 || hasSubcategories || hasFiles) {
                        categoryHTML = `
                            <div class="hierarchy-category" style="margin-left: ${indent}px;">
                                <div class="category-header p-2 rounded cursor-pointer hover:bg-gray-50 flex items-center justify-between"
                                     onclick="app.toggleCategory('${item.id}')">
                                    <div class="flex items-center">
                                        ${hasSubcategories || hasFiles ? `
                                            <span class="material-icons text-sm mr-2 transition-transform ${isExpanded ? 'rotate-90' : ''}">
                                                chevron_right
                                            </span>
                                        ` : ''}
                                        <span class="material-icons text-sm mr-2 text-gray-600">${sectionIcon}</span>
                                        <span class="font-medium text-gray-700 ${level === 0 ? 'text-base' : 'text-sm'}">${item.title}</span>
                                    </div>
                                </div>
                                
                                <div class="category-content ${isExpanded ? 'block' : 'hidden'}" id="category-${item.id}">
                                    ${hasFiles ? this.renderFiles(item.files, level + 1) : ''}
                                    ${hasSubcategories ? this.renderHierarchyLevel(item.subcategories, level + 1) : ''}
                                </div>
                            </div>
                        `;
                    }
                    
                    return categoryHTML;
                }).join('');
            },

            renderFiles(files, level) {
                const indent = level * 16;
                return files.map(file => {
                    // Check if this section exists in guideData
                    const sectionExists = guideData.sections.some(s => s.id === file.id);
                    const fileIcon = this.getSectionIcon(file.id, file.title, level);
                    
                    return `
                        <div class="file-item p-2 rounded cursor-pointer hover:bg-blue-50 transition-colors ${guideData.currentSection === file.id ? 'bg-blue-100' : ''}" 
                             style="margin-left: ${indent}px;"
                             data-section="${file.id}"
                             onclick="app.selectSection('${file.id}')">
                            <div class="flex items-center">
                                <span class="material-icons text-sm text-blue-600 mr-2">${fileIcon}</span>
                                <span class="text-sm text-gray-700">${file.title}</span>
                                ${!sectionExists ? '<span class="ml-2 text-xs text-red-500" title="Section not found in guideData">‚ö†Ô∏è</span>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            },

            isExpanded(categoryId) {
                // Default all categories to collapsed
                if (!this.expandedCategories) {
                    this.expandedCategories = new Set();
                }
                return this.expandedCategories.has(categoryId);
            },

            toggleCategory(categoryId) {
                if (!this.expandedCategories) {
                    this.expandedCategories = new Set();
                }
                
                if (this.expandedCategories.has(categoryId)) {
                    this.expandedCategories.delete(categoryId);
                } else {
                    this.expandedCategories.add(categoryId);
                }
                
                const categoryContent = document.getElementById(`category-${categoryId}`);
                const chevron = document.querySelector(`[onclick="app.toggleCategory('${categoryId}')"] .material-icons`);
                
                if (categoryContent) {
                    categoryContent.classList.toggle('hidden');
                    if (chevron) {
                        chevron.classList.toggle('rotate-90');
                    }
                }
            },

            generateStatsInfographic() {
                const stats = snomedStats;
                const topHierarchies = stats.hierarchies
                    .filter(h => h.active > 1000) // Only show hierarchies with significant content
                    .sort((a, b) => b.active - a.active)
                    .slice(0, 6); // Top 6 hierarchies
                
                return `
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <span class="material-icons text-blue-600 mr-3">analytics</span>
                            SNOMED CT Release Statistics (July 2025)
                        </h2>
                        
                        <!-- Summary Stats -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-white rounded-lg p-4 text-center shadow-sm stats-card animate-fade-in-up">
                                <div class="text-2xl font-bold text-blue-600">${stats.totalActive.toLocaleString()}</div>
                                <div class="text-sm text-gray-600">Active Concepts</div>
                            </div>
                            <div class="bg-white rounded-lg p-4 text-center shadow-sm stats-card animate-fade-in-up" style="animation-delay: 0.1s;">
                                <div class="text-2xl font-bold text-green-600">${stats.summary.totalNew.toLocaleString()}</div>
                                <div class="text-sm text-gray-600">New Concepts</div>
                            </div>
                            <div class="bg-white rounded-lg p-4 text-center shadow-sm stats-card animate-fade-in-up" style="animation-delay: 0.2s;">
                                <div class="text-2xl font-bold text-orange-600">${stats.summary.totalChanged.toLocaleString()}</div>
                                <div class="text-sm text-gray-600">Changed Concepts</div>
                            </div>
                            <div class="bg-white rounded-lg p-4 text-center shadow-sm stats-card animate-fade-in-up" style="animation-delay: 0.3s;">
                                <div class="text-2xl font-bold text-red-600">${stats.summary.totalInactivated.toLocaleString()}</div>
                                <div class="text-sm text-gray-600">Inactivated Concepts</div>
                            </div>
                        </div>
                        
                        <!-- Top Hierarchies Chart -->
                        <div class="bg-white rounded-lg p-6 shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Top Hierarchies by Active Concepts</h3>
                            <div class="space-y-3">
                                ${topHierarchies.map(hierarchy => {
                                    const percentage = ((hierarchy.active / stats.totalActive) * 100).toFixed(1);
                                    return `
                                        <div class="flex items-center justify-between">
                                            <div class="flex-1">
                                                <div class="flex items-center justify-between mb-1">
                                                    <span class="text-sm font-medium text-gray-700">${hierarchy.name.split(' (')[0]}</span>
                                                    <span class="text-sm text-gray-500">${hierarchy.active.toLocaleString()} (${percentage}%)</span>
                                                </div>
                                                <div class="w-full bg-gray-200 rounded-full h-2">
                                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- Recent Activity -->
                        <div class="grid md:grid-cols-2 gap-4 mt-6">
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <h4 class="font-semibold text-gray-800 mb-3">New Concepts by Type</h4>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-600">Fully Defined (SD)</span>
                                        <span class="text-sm font-medium">${stats.summary.newSD}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-600">Primitive (P)</span>
                                        <span class="text-sm font-medium">${stats.summary.newP}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <h4 class="font-semibold text-gray-800 mb-3">Release Summary</h4>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-600">Total Concepts</span>
                                        <span class="text-sm font-medium">${stats.totalConcepts.toLocaleString()}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-600">Reactivated</span>
                                        <span class="text-sm font-medium">${stats.summary.totalReactivated}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            generateHierarchyStats(hierarchyId) {
                const hierarchy = snomedStats.hierarchies.find(h => h.id === hierarchyId);
                if (!hierarchy) return '';
                
                const percentage = ((hierarchy.active / snomedStats.totalActive) * 100).toFixed(1);
                
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6 shadow-sm">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="material-icons text-blue-600 mr-2">assessment</span>
                            ${hierarchy.name.split(' (')[0]} Hierarchy Statistics
                        </h3>
                        
                        <!-- Main Stats Cards -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-blue-50 rounded-lg p-4 text-center hierarchy-stats-card">
                                <div class="text-2xl font-bold text-blue-600">${hierarchy.active.toLocaleString()}</div>
                                <div class="text-sm font-medium text-gray-700 mb-1">ACTIVE CONCEPTS</div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full hierarchy-progress-bar" style="width: ${percentage}%"></div>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">${percentage}% of total</div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4 text-center hierarchy-stats-card">
                                <div class="text-2xl font-bold text-gray-700">${hierarchy.total.toLocaleString()}</div>
                                <div class="text-sm font-medium text-gray-700 mb-1">TOTAL CONCEPTS</div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-gray-400 h-2 rounded-full hierarchy-progress-bar" style="width: 100%"></div>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">All time</div>
                            </div>
                            
                            <div class="bg-green-50 rounded-lg p-4 text-center hierarchy-stats-card">
                                <div class="text-2xl font-bold text-green-600">${hierarchy.new}</div>
                                <div class="text-sm font-medium text-gray-700 mb-1">NEW THIS RELEASE</div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full hierarchy-progress-bar" style="width: ${hierarchy.new > 0 ? '100' : '0'}%"></div>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">${hierarchy.new > 0 ? '+' + hierarchy.new : 'No changes'}</div>
                            </div>
                            
                            <div class="bg-orange-50 rounded-lg p-4 text-center hierarchy-stats-card">
                                <div class="text-2xl font-bold text-orange-600">${hierarchy.changed}</div>
                                <div class="text-sm font-medium text-gray-700 mb-1">MODIFIED</div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-orange-500 h-2 rounded-full hierarchy-progress-bar" style="width: ${hierarchy.changed > 0 ? '100' : '0'}%"></div>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">${hierarchy.changed > 0 ? 'Updated' : 'No changes'}</div>
                            </div>
                        </div>
                        
                        <!-- Recent Activity Section -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">Recent Activity</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">New concepts added:</span>
                                    <span class="text-sm font-medium text-green-600">${hierarchy.new}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Concepts modified:</span>
                                    <span class="text-sm font-medium text-blue-600">${hierarchy.changed}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Concepts inactivated:</span>
                                    <span class="text-sm font-medium text-red-600">${hierarchy.inactivated}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Market share:</span>
                                    <span class="text-sm font-medium text-gray-800">${percentage}% of all active concepts</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            showStatisticsDashboard() {
                // Scroll to top when showing statistics dashboard
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                const content = document.getElementById('content');
                const stats = snomedStats;
                
                content.innerHTML = `
                    <div class="bg-white rounded-lg shadow-lg p-8 animate-slide-in">
                        <div class="flex items-center mb-6 pb-4 border-b border-gray-200">
                            <span class="material-icons text-blue-600 mr-3 text-4xl">analytics</span>
                            <div>
                                <h1 class="text-3xl font-bold text-gray-800 m-0">SNOMED CT Statistics Dashboard</h1>
                                <p class="text-gray-600 mt-1">Comprehensive Release Statistics - July 2025</p>
                            </div>
                        </div>
                        
                        ${this.generateStatsInfographic()}
                        
                        <!-- Detailed Hierarchy Table -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800">All Hierarchies - Detailed Statistics</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hierarchy</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Active</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">New</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Inactivated</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">% of Total</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${stats.hierarchies.map(hierarchy => {
                                            const percentage = ((hierarchy.active / stats.totalActive) * 100).toFixed(1);
                                            return `
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="text-sm font-medium text-gray-900">${hierarchy.name.split(' (')[0]}</div>
                                                        <div class="text-sm text-gray-500">${hierarchy.semTag}</div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${hierarchy.active.toLocaleString()}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${hierarchy.total.toLocaleString()}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${hierarchy.new > 0 ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                                            ${hierarchy.new}
                                                        </span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${hierarchy.changed > 0 ? 'bg-orange-100 text-orange-800' : 'bg-gray-100 text-gray-800'}">
                                                            ${hierarchy.changed}
                                                        </span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${hierarchy.inactivated > 0 ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">
                                                            ${hierarchy.inactivated}
                                                        </span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${percentage}%</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Data Source Information -->
                        <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600">
                                <strong>Data Source:</strong> SNOMED CT Release Statistics from 
                                <a href="https://docs.google.com/spreadsheets/d/14gb0i0dDeeQa24dL31wX-kVzv_q4N2yS_N2LXO6vvjA/edit?gid=0#gid=0" 
                                   target="_blank" class="text-blue-600 hover:text-blue-800 underline">
                                    Google Sheets Summary Component Stats
                                </a>
                            </p>
                        </div>
                    </div>
                `;
            },

            showLandingPage() {
                console.log('üè† Returning to landing page');
                
                // Update URL to landing page
                this.updateURL('landing');
                
                // Scroll to top when showing landing page
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Clear content and show landing page with tabs
                const contentContainer = document.getElementById('content');
                contentContainer.innerHTML = `
                    <div class="content-area animate-slide-in">
                        <!-- Hero Section -->
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-2xl p-12 mb-8">
                            <div class="text-center mb-8">
                                <div class="flex items-center justify-center mb-8">
                                    <div class="flex items-center justify-center w-24 h-24 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl mr-6 shadow-xl">
                                        <span class="material-icons text-white text-6xl">medical_services</span>
                                    </div>
                                    <h1 class="text-5xl font-bold bg-gradient-to-r from-blue-600 to-blue-800 bg-clip-text text-transparent">SNOMED CT Editorial Guide</h1>
                                </div>
                                <p class="text-2xl text-gray-700 max-w-4xl mx-auto leading-relaxed mb-8">
                                    Interactive browser for the comprehensive SNOMED CT Editorial Guide, providing guidelines for clinical terminology management and implementation.
                                </p>
                                <div class="flex items-center justify-center space-x-8 text-gray-600">
                                    <div class="flex items-center">
                                        <span class="material-icons mr-2">article</span>
                                        <span>Comprehensive Documentation</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="material-icons mr-2">search</span>
                                        <span>Advanced Search</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="material-icons mr-2">smart_toy</span>
                                        <span>AI Assistant</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Navigation -->
                        <div class="bg-white rounded-2xl shadow-lg mb-8">
                            <div class="border-b border-gray-200">
                                <nav class="flex space-x-8 px-8" aria-label="Tabs">
                                    <button onclick="app.showLandingTab('overview')" 
                                            id="tab-overview"
                                            class="tab-button active py-4 px-1 border-b-2 border-transparent font-medium text-sm transition-colors duration-200 flex items-center">
                                        <span class="material-icons mr-2">home</span>
                                        Overview
                                    </button>
                                    <button onclick="app.showLandingTab('statistics')" 
                                            id="tab-statistics"
                                            class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm transition-colors duration-200 flex items-center">
                                        <span class="material-icons mr-2">analytics</span>
                                        Statistics Dashboard
                                    </button>
                                </nav>
                            </div>
                            
                            <!-- Tab Content -->
                            <div class="p-8">
                                <!-- Overview Tab Content -->
                                <div id="tab-content-overview" class="tab-content active">
                                    <!-- What is SNOMED CT Section -->
                                    <div class="bg-white rounded-2xl shadow-lg p-8 mb-12">
                                        <div class="flex items-center mb-6">
                                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                                                <span class="material-icons text-blue-600 text-2xl">info</span>
                                            </div>
                                            <h2 class="text-3xl font-bold text-gray-800">What is SNOMED CT?</h2>
                                        </div>
                                        <div class="grid md:grid-cols-2 gap-8">
                                            <div>
                                                <h3 class="text-xl font-semibold text-gray-800 mb-4">Clinical Terminology Standard</h3>
                                                <p class="text-gray-600 leading-relaxed mb-4">
                                                    SNOMED CT (Systematized Nomenclature of Medicine -- Clinical Terms) is a comprehensive, multilingual clinical healthcare terminology that enables the consistent representation of clinical content in electronic health records.
                                                </p>
                                                <p class="text-gray-600 leading-relaxed">
                                                    It provides the core general terminology for electronic health records and contains more than 350,000 active concepts with unique meanings and formal logic-based definitions organized into hierarchies.
                                                </p>
                                            </div>
                                            <div>
                                                <h3 class="text-xl font-semibold text-gray-800 mb-4">Global Healthcare Standard</h3>
                                                <p class="text-gray-600 leading-relaxed mb-4">
                                                    SNOMED CT is used in over 80 countries and is the most comprehensive clinical terminology available. It's maintained by SNOMED International, a not-for-profit organization owned by its member countries.
                                                </p>
                                                <div class="bg-blue-50 rounded-lg p-4">
                                                    <div class="flex items-center mb-2">
                                                        <span class="material-icons text-blue-600 mr-2">analytics</span>
                                                        <span class="font-semibold text-blue-800">Current Release Statistics</span>
                                                    </div>
                                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                                        <div>
                                                            <div class="font-bold text-blue-600">${snomedStats.totalActive.toLocaleString()}</div>
                                                            <div class="text-blue-700">Active Concepts</div>
                                                        </div>
                                                        <div>
                                                            <div class="font-bold text-blue-600">${snomedStats.hierarchies.length}</div>
                                                            <div class="text-blue-700">Hierarchies</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Editorial Guide Overview -->
                                    <div class="bg-white rounded-2xl shadow-lg p-8 mb-12">
                                        <div class="flex items-center mb-6">
                                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                                                <span class="material-icons text-green-600 text-2xl">description</span>
                                            </div>
                                            <h2 class="text-3xl font-bold text-gray-800">SNOMED CT Editorial Guide</h2>
                                        </div>
                                        <div class="grid md:grid-cols-2 gap-8">
                                            <div>
                                                <h3 class="text-xl font-semibold text-gray-800 mb-4">Comprehensive Guidelines</h3>
                                                <p class="text-gray-600 leading-relaxed mb-4">
                                                    The SNOMED CT Editorial Guide provides comprehensive guidelines for creating, maintaining, and implementing SNOMED CT content. It serves as the definitive reference for terminology developers, implementers, and clinicians.
                                                </p>
                                    <p class="text-gray-600 leading-relaxed">
                                        The guide covers concept modeling, naming conventions, authoring principles, and domain-specific guidelines to ensure consistent and high-quality terminology development.
                                    </p>
                                </div>
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Key Components</h3>
                                    <ul class="space-y-3 text-gray-600">
                                        <li class="flex items-start">
                                            <span class="material-icons text-green-600 mr-2 mt-0.5 text-sm">check_circle</span>
                                            <span>Concept Model Overview and Principles</span>
                                        </li>
                                        <li class="flex items-start">
                                            <span class="material-icons text-green-600 mr-2 mt-0.5 text-sm">check_circle</span>
                                            <span>Domain-Specific Modeling Guidelines</span>
                                        </li>
                                        <li class="flex items-start">
                                            <span class="material-icons text-green-600 mr-2 mt-0.5 text-sm">check_circle</span>
                                            <span>Naming Conventions and Style Guide</span>
                                        </li>
                                        <li class="flex items-start">
                                            <span class="material-icons text-green-600 mr-2 mt-0.5 text-sm">check_circle</span>
                                            <span>Authoring and Maintenance Procedures</span>
                                        </li>
                                        <li class="flex items-start">
                                            <span class="material-icons text-green-600 mr-2 mt-0.5 text-sm">check_circle</span>
                                            <span>Implementation and Migration Guidance</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Application Features -->
                        <div class="bg-white rounded-2xl shadow-lg p-8 mb-12">
                            <div class="flex items-center mb-6">
                                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                                    <span class="material-icons text-purple-600 text-2xl">apps</span>
                                </div>
                                <h2 class="text-3xl font-bold text-gray-800">Application Features</h2>
                            </div>
                            <div class="grid md:grid-cols-3 gap-6">
                                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6">
                                    <div class="flex items-center mb-4">
                                        <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center mr-3">
                                            <span class="material-icons text-white">search</span>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-800">Advanced Search</h3>
                                    </div>
                                    <p class="text-gray-600 text-sm leading-relaxed">
                                        Powerful search functionality with real-time suggestions, concept ID lookup, and semantic search across all editorial guide content.
                                    </p>
                                    <div class="mt-4 text-xs text-gray-500">
                                        <span class="material-icons text-xs mr-1">keyboard</span>
                                        Press Ctrl+K to search
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6">
                                    <div class="flex items-center mb-4">
                                        <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center mr-3">
                                            <span class="material-icons text-white">smart_toy</span>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-800">AI Assistant</h3>
                                    </div>
                                    <p class="text-gray-600 text-sm leading-relaxed">
                                        Intelligent AI-powered assistant that can answer questions about SNOMED CT guidelines, provide explanations, and help with terminology development.
                                    </p>
                                    <div class="mt-4 text-xs text-gray-500">
                                        <span class="material-icons text-xs mr-1">chat</span>
                                        Click AI button in header
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6">
                                    <div class="flex items-center mb-4">
                                        <div class="w-10 h-10 bg-purple-500 rounded-lg flex items-center justify-center mr-3">
                                            <span class="material-icons text-white">link</span>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-800">Direct Linking</h3>
                                    </div>
                                    <p class="text-gray-600 text-sm leading-relaxed">
                                        Shareable URLs for specific sections, enabling direct navigation to relevant content and easy reference sharing.
                                    </p>
                                    <div class="mt-4 text-xs text-gray-500">
                                        <span class="material-icons text-xs mr-1">share</span>
                                        URLs update automatically
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-6">
                                    <div class="flex items-center mb-4">
                                        <div class="w-10 h-10 bg-orange-500 rounded-lg flex items-center justify-center mr-3">
                                            <span class="material-icons text-white">analytics</span>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-800">Live HRCM Tables</h3>
                                    </div>
                                    <p class="text-gray-600 text-sm leading-relaxed">
                                        Dynamic Human Readable Concept Model tables with live data from SNOMED CT MRCM refsets, showing current attribute constraints.
                                    </p>
                                    <div class="mt-4 text-xs text-gray-500">
                                        <span class="material-icons text-xs mr-1">refresh</span>
                                        Real-time data updates
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-xl p-6">
                                    <div class="flex items-center mb-4">
                                        <div class="w-10 h-10 bg-red-500 rounded-lg flex items-center justify-center mr-3">
                                            <span class="material-icons text-white">navigation</span>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-800">Hierarchical Navigation</h3>
                                    </div>
                                    <p class="text-gray-600 text-sm leading-relaxed">
                                        Intuitive hierarchical navigation structure that mirrors the SNOMED CT Editorial Guide organization for easy content discovery.
                                    </p>
                                    <div class="mt-4 text-xs text-gray-500">
                                        <span class="material-icons text-xs mr-1">folder</span>
                                        Expandable categories
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-br from-teal-50 to-teal-100 rounded-xl p-6">
                                    <div class="flex items-center mb-4">
                                        <div class="w-10 h-10 bg-teal-500 rounded-lg flex items-center justify-center mr-3">
                                            <span class="material-icons text-white">devices</span>
                                        </div>
                                        <h3 class="text-lg font-semibold text-gray-800">Responsive Design</h3>
                                    </div>
                                    <p class="text-gray-600 text-sm leading-relaxed">
                                        Fully responsive design that works seamlessly across desktop, tablet, and mobile devices with optimized layouts for each screen size.
                                    </p>
                                    <div class="mt-4 text-xs text-gray-500">
                                        <span class="material-icons text-xs mr-1">phone_android</span>
                                        Mobile-friendly interface
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Start Guide -->
                        <div class="bg-white rounded-2xl shadow-lg p-8 mb-12">
                            <div class="flex items-center mb-6">
                                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mr-4">
                                    <span class="material-icons text-orange-600 text-2xl">rocket_launch</span>
                                </div>
                                <h2 class="text-3xl font-bold text-gray-800">Quick Start Guide</h2>
                            </div>
                            <div class="grid md:grid-cols-2 gap-8">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Getting Started</h3>
                                    <div class="space-y-4">
                                        <div class="flex items-start">
                                            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center mr-3 mt-1 text-sm font-bold">1</div>
                                            <div>
                                                <p class="font-medium text-gray-800">Explore the Navigation</p>
                                                <p class="text-gray-600 text-sm">Use the sidebar to browse through different sections of the editorial guide.</p>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center mr-3 mt-1 text-sm font-bold">2</div>
                                            <div>
                                                <p class="font-medium text-gray-800">Search for Content</p>
                                                <p class="text-gray-600 text-sm">Use the search bar (Ctrl+K) to find specific topics or concept IDs.</p>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center mr-3 mt-1 text-sm font-bold">3</div>
                                            <div>
                                                <p class="font-medium text-gray-800">Ask the AI Assistant</p>
                                                <p class="text-gray-600 text-sm">Click the AI button for help with SNOMED CT questions and guidance.</p>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center mr-3 mt-1 text-sm font-bold">4</div>
                                            <div>
                                                <p class="font-medium text-gray-800">View Live Data</p>
                                                <p class="text-gray-600 text-sm">Explore HRCM tables for current attribute constraints and modeling rules.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Popular Sections</h3>
                                    <div class="space-y-3">
                                        <button onclick="app.selectSection('snomed-ct-introduction')" class="w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                            <div class="flex items-center">
                                                <span class="material-icons text-blue-600 mr-3">info</span>
                                                <div>
                                                    <p class="font-medium text-gray-800">SNOMED CT Introduction</p>
                                                    <p class="text-sm text-gray-600">Overview and basic concepts</p>
                                                </div>
                                            </div>
                                        </button>
                                        <button onclick="app.selectSection('concept-model-overview')" class="w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                            <div class="flex items-center">
                                                <span class="material-icons text-green-600 mr-3">schema</span>
                                                <div>
                                                    <p class="font-medium text-gray-800">Concept Model Overview</p>
                                                    <p class="text-sm text-gray-600">Understanding concept modeling</p>
                                                </div>
                                            </div>
                                        </button>
                                        <button onclick="app.selectSection('clinical-finding-attributes-summary')" class="w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                            <div class="flex items-center">
                                                <span class="material-icons text-purple-600 mr-3">analytics</span>
                                                <div>
                                                    <p class="font-medium text-gray-800">Clinical Finding HRCM</p>
                                                    <p class="text-sm text-gray-600">Live attribute constraints</p>
                                                </div>
                                            </div>
                                        </button>
                                        <button onclick="app.showLandingPage()" class="w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                            <div class="flex items-center">
                                                <span class="material-icons text-orange-600 mr-3">home</span>
                                                <div>
                                                    <p class="font-medium text-gray-800">Home Page</p>
                                                    <p class="text-sm text-gray-600">Overview and statistics dashboard</p>
                                                </div>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Resources and Links -->
                        <div class="bg-white rounded-2xl shadow-lg p-8">
                            <div class="flex items-center mb-6">
                                <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center mr-4">
                                    <span class="material-icons text-indigo-600 text-2xl">link</span>
                                </div>
                                <h2 class="text-3xl font-bold text-gray-800">Additional Resources</h2>
                            </div>
                            <div class="grid md:grid-cols-2 gap-8">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Official SNOMED CT Resources</h3>
                                    <div class="space-y-3">
                                        <a href="https://www.snomed.org/" target="_blank" class="flex items-center p-3 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">
                                            <span class="material-icons text-blue-600 mr-3">public</span>
                                            <div>
                                                <p class="font-medium text-gray-800">SNOMED International</p>
                                                <p class="text-sm text-gray-600">Official website and resources</p>
                                            </div>
                                        </a>
                                        <a href="https://confluence.ihtsdotools.org/display/DOCEG/PDFs+for+Download" target="_blank" class="flex items-center p-3 bg-green-50 rounded-lg hover:bg-green-100 transition-colors">
                                            <span class="material-icons text-green-600 mr-3">download</span>
                                            <div>
                                                <p class="font-medium text-gray-800">PDF Downloads</p>
                                                <p class="text-sm text-gray-600">Official editorial guide PDFs</p>
                                            </div>
                                        </a>
                                        <a href="https://www.snomed.org/snomed-ct/education" target="_blank" class="flex items-center p-3 bg-purple-50 rounded-lg hover:bg-purple-100 transition-colors">
                                            <span class="material-icons text-purple-600 mr-3">school</span>
                                            <div>
                                                <p class="font-medium text-gray-800">Education & Training</p>
                                                <p class="text-sm text-gray-600">Learning resources and courses</p>
                                            </div>
                                        </a>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Application Information</h3>
                                    <div class="bg-gray-50 rounded-lg p-4">
                                        <div class="space-y-3 text-sm">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Current Guide Version:</span>
                                                <span class="font-medium">2025-01-08</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">SNOMED CT Release:</span>
                                                <span class="font-medium">July 2025</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Total Active Concepts:</span>
                                                <span class="font-medium">${snomedStats.totalActive.toLocaleString()}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Hierarchies Covered:</span>
                                                <span class="font-medium">${snomedStats.hierarchies.length}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4 text-center">
                                        <p class="text-sm text-gray-500 mb-2">This application is designed to complement the official SNOMED CT Editorial Guide</p>
                                        <p class="text-xs text-gray-400">¬© 2025 SNOMED International. All rights reserved.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                                    </div>
                                    
                                    <!-- Statistics Tab Content -->
                                    <div id="tab-content-statistics" class="tab-content hidden">
                                        ${this.generateStatsInfographic()}
                                        
                                        <!-- Detailed Hierarchy Table -->
                                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                                            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                                                <h3 class="text-lg font-semibold text-gray-800">All Hierarchies - Detailed Statistics</h3>
                                            </div>
                                            <div class="overflow-x-auto">
                                                <table class="min-w-full divide-y divide-gray-200">
                                                    <thead class="bg-gray-50">
                                                        <tr>
                                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hierarchy</th>
                                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Active</th>
                                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">New</th>
                                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed</th>
                                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Inactivated</th>
                                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">% of Total</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody class="bg-white divide-y divide-gray-200">
                                                        ${snomedStats.hierarchies.map(hierarchy => {
                                                            const percentage = ((hierarchy.active / snomedStats.totalActive) * 100).toFixed(1);
                                                            return `
                                                                <tr class="hover:bg-gray-50">
                                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                                        <div class="text-sm font-medium text-gray-900">${hierarchy.name.split(' (')[0]}</div>
                                                                        <div class="text-sm text-gray-500">${hierarchy.semTag}</div>
                                                                    </td>
                                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${hierarchy.active.toLocaleString()}</td>
                                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${hierarchy.total.toLocaleString()}</td>
                                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${hierarchy.new > 0 ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                                                            ${hierarchy.new}
                                                                        </span>
                                                                    </td>
                                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${hierarchy.changed > 0 ? 'bg-orange-100 text-orange-800' : 'bg-gray-100 text-gray-800'}">
                                                                            ${hierarchy.changed}
                                                                        </span>
                                                                    </td>
                                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${hierarchy.inactivated > 0 ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">
                                                                            ${hierarchy.inactivated}
                                                                        </span>
                                                                    </td>
                                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${percentage}%</td>
                                                                </tr>
                                                            `;
                                                        }).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        
                                        <!-- Data Source Information -->
                                        <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                                            <p class="text-sm text-gray-600">
                                                <strong>Data Source:</strong> SNOMED CT Release Statistics from 
                                                <a href="https://docs.google.com/spreadsheets/d/14gb0i0dDeeQa24dL31wX-kVzv_q4N2yS_N2LXO6vvjA/edit?gid=0#gid=0" 
                                                   target="_blank" class="text-blue-600 hover:text-blue-800 underline">
                                                    Google Sheets Summary Component Stats
                                                </a>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Clear navigation highlighting
                document.querySelectorAll('.file-item.bg-blue-100').forEach(item => {
                    item.classList.remove('bg-blue-100');
                });
                
                // Update current section
                guideData.currentSection = 'landing';
                
                console.log('‚úÖ Landing page loaded');
            },

            showLandingTab(tabName) {
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                    content.classList.remove('active');
                });
                
                // Remove active class from all tab buttons
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                    button.classList.remove('border-blue-500');
                    button.classList.remove('text-blue-600');
                    button.classList.add('border-transparent');
                    button.classList.add('text-gray-500');
                });
                
                // Show selected tab content
                const selectedContent = document.getElementById(`tab-content-${tabName}`);
                if (selectedContent) {
                    selectedContent.classList.remove('hidden');
                    selectedContent.classList.add('active');
                }
                
                // Activate selected tab button
                const selectedButton = document.getElementById(`tab-${tabName}`);
                if (selectedButton) {
                    selectedButton.classList.add('active');
                    selectedButton.classList.add('border-blue-500');
                    selectedButton.classList.add('text-blue-600');
                    selectedButton.classList.remove('border-transparent');
                    selectedButton.classList.remove('text-gray-500');
                }
            },

            renderContent() {
                const content = document.getElementById('content');
                
                if (guideData.searchResults.length > 0) {
                    this.renderSearchResults();
                    return;
                }

                const section = guideData.sections.find(s => s.id === guideData.currentSection);
                if (!section) {
                    this.showLandingPage();
                    return;
                }
                
                // Scroll to top when rendering new content (except for landing page)
                if (guideData.currentSection !== 'landing') {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }

                // If the section is backed by a Markdown file, load and render it dynamically
                if (section.mdFile) {
                    // Check if this is an HRCM section that should use dynamic MRCM data
                    console.log('Section ID being checked:', section.id);
                    
                    // HRCM section detection (debug logs in console)
                    if (section.id.includes('attributes-summary') || section.id.includes('attribute-summary')) {
                        console.log('üìä HRCM section detected:', section.id, 'isHRCM:', this.isHRCMSection(section.id));
                    }
                    
                    if (this.isHRCMSection(section.id) || section.id === 'clinical-finding-attributes-summary') {
                        // Show loading state for HRCM table
                        content.innerHTML = `
                            <div class="bg-white rounded-lg shadow-lg p-8">
                                <div class="content-loading">
                                    <div class="text-center">
                                        <div class="loading-spinner mx-auto mb-4"></div>
                                        <p class="text-gray-600">Loading live HRCM data for ${section.title}...</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Render HRCM table with live MRCM data
                        this.renderHRCMTable(section.id, section.title)
                            .then(hrcmHTML => {
                                                content.innerHTML = `
                    <div class="content-area p-8 animate-slide-in">
                        <div class="flex items-center mb-8 pb-6 border-b border-gray-200">
                            <div class="flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl mr-6 shadow-lg">
                                <span class="material-icons text-white text-3xl">table_chart</span>
                            </div>
                            <div>
                                <h1 class="text-4xl font-bold text-gray-800 m-0 mb-2">${section.title}</h1>
                                <p class="text-gray-600 text-lg">SNOMED CT Editorial Guide - Live MRCM Data</p>
                            </div>
                        </div>
                        <div id="hrcm-content-${section.id}" class="markdown-content">
                            ${hrcmHTML}
                        </div>
                    </div>
                `;
                                
                                // Add click handlers for SNOMED CT concept IDs
                                content.querySelectorAll('.concept-id').forEach(element => {
                                    element.addEventListener('click', (e) => {
                                        const conceptId = e.target.getAttribute('data-concept-id');
                                        if (conceptId) {
                                            // Create a simple tooltip or modal showing concept details
                                            const tooltip = document.createElement('div');
                                            tooltip.className = 'fixed bg-gray-800 text-white px-3 py-2 rounded shadow-lg z-50 text-sm';
                                            tooltip.textContent = `Concept ID: ${conceptId} (Click to view in browser)`;
                                            tooltip.style.left = e.pageX + 'px';
                                            tooltip.style.top = (e.pageY - 40) + 'px';
                                            document.body.appendChild(tooltip);
                                            
                                            setTimeout(() => {
                                                if (tooltip.parentNode) {
                                                    tooltip.parentNode.removeChild(tooltip);
                                                }
                                            }, 2000);
                                            
                                            // Optional: Open SNOMED CT browser
                                            // window.open(`https://browser.ihtsdotools.org/?perspective=full&conceptId1=${conceptId}`, '_blank');
                                        }
                                    });
                                });
                                

                            })
                            .catch(err => {
                                console.error('Error rendering HRCM table:', err);
                                content.innerHTML = `
                                    <div class="bg-white rounded-lg shadow-lg p-8">
                                        <div class="flex items-center text-red-600">
                                            <span class="material-icons mr-2">error</span>
                                            <div>
                                                <p class="text-lg font-semibold">Failed to load HRCM data</p>
                                                <p class="text-gray-600 mt-2">Unable to load live MRCM data for: ${section.title}</p>
                                                <p class="text-sm text-gray-500 mt-1">Error: ${err.message}</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                        return;
                    }
                    
                    // Show loading state for regular markdown
                    content.innerHTML = `
                        <div class="bg-white rounded-lg shadow-lg p-8">
                            <div class="content-loading">
                                <div class="text-center">
                                    <div class="loading-spinner mx-auto mb-4"></div>
                                    <p class="text-gray-600">Loading ${section.title}...</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    fetch(section.mdFile)
                        .then(res => res.text())
                        .then(md => {
                            let html = marked.parse(md);
                            
                            // Enhanced processing for SNOMED CT content
                            html = this.enhanceMarkdownContent(html);
                            
                            // Inject relevant statistics into the content
                            html = this.injectStatisticsIntoContent(html, section.id);
                            
                                            content.innerHTML = `
                    <div class="content-area p-8 animate-slide-in">
                        <div class="flex items-center mb-8 pb-6 border-b border-gray-200">
                            <div class="flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl mr-6 shadow-lg">
                                <span class="material-icons text-white text-3xl">article</span>
                            </div>
                            <div>
                                <h1 class="text-4xl font-bold text-gray-800 m-0 mb-2">${section.title}</h1>
                                <p class="text-gray-600 text-lg">SNOMED CT Editorial Guide</p>
                            </div>
                        </div>
                        <article class="markdown-content">${html}</article>
                    </div>
                `;
                            
                            // Add click handlers for SNOMED CT concept IDs
                            content.querySelectorAll('.concept-id').forEach(element => {
                                element.addEventListener('click', (e) => {
                                    const conceptId = e.target.getAttribute('data-concept-id');
                                    if (conceptId) {
                                        // Create a simple tooltip or modal showing concept details
                                        const tooltip = document.createElement('div');
                                        tooltip.className = 'fixed bg-gray-800 text-white px-3 py-2 rounded shadow-lg z-50 text-sm';
                                        tooltip.textContent = `Concept ID: ${conceptId} (Click to view in browser)`;
                                        tooltip.style.left = e.pageX + 'px';
                                        tooltip.style.top = (e.pageY - 40) + 'px';
                                        document.body.appendChild(tooltip);
                                        
                                        setTimeout(() => {
                                            if (tooltip.parentNode) {
                                                tooltip.parentNode.removeChild(tooltip);
                                            }
                                        }, 2000);
                                        
                                        // Optional: Open SNOMED CT browser
                                        // window.open(`https://browser.ihtsdotools.org/?perspective=full&conceptId1=${conceptId}`, '_blank');
                                    }
                                });
                            });
                            

                        })
                        .catch(err => {
                            console.error('Error loading markdown file', section.mdFile, err);
                            content.innerHTML = `
                                <div class="bg-white rounded-lg shadow-lg p-8">
                                    <div class="flex items-center text-red-600">
                                        <span class="material-icons mr-2">error</span>
                                        <p class="text-lg font-semibold">Failed to load content</p>
                                    </div>
                                    <p class="text-gray-600 mt-2">Unable to load the markdown file: ${section.mdFile}</p>
                                </div>
                            `;
                        });
                    return;
                }

                // Render various content types dynamically
                const renderContentList = (items, title, icon = 'check_circle', bgColor = 'bg-blue-50') => {
                    if (!items) return '';
                    
                    // Handle case where items is not an array
                    if (!Array.isArray(items)) {
                        // Fall back to renderContentCards for non-arrays
                        return renderContentCards(items, title, bgColor, 'border-green-400');
                    }
                    
                    return `
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">${title}</h3>
                            <ul class="space-y-2">
                                ${items.map(item => `
                                    <li class="flex items-start space-x-2">
                                        <span class="material-icons text-green-600 text-sm mt-1">${icon}</span>
                                        <span class="text-gray-700">${item}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                };

                                const renderContentCards = (items, title, bgColor = 'bg-blue-50', borderColor = 'border-blue-400') => {
                    if (!items) return '';
                    
                    // Handle case where items is not an array
                    if (!Array.isArray(items)) {
                        // If it's an object, render each property
                        if (typeof items === 'object') {
                            const renderValue = (value, key) => {
                                if (Array.isArray(value)) {
                                    // Handle arrays of objects (like examples)
                                    if (value.length > 0 && typeof value[0] === 'object') {
                                        return value.map(item => {
                                            if (item.type && item.concept) {
                                                // Enhanced section example format
                                                return `<div class="ml-4 mb-2 p-3 bg-gray-50 rounded">
                                                    <div class="font-medium text-gray-800">${item.type}: ${item.concept}</div>
                                                    ${item.id ? `<div class="text-sm text-gray-600">ID: ${item.id}</div>` : ''}
                                                    ${item.description ? `<div class="text-sm text-gray-700 mt-1">${item.description}</div>` : ''}
                                                </div>`;
                                            } else {
                                                // General object format
                                                return `<div class="ml-4 mb-2 p-2 bg-gray-50 rounded">${JSON.stringify(item, null, 2).replace(/[{}",]/g, '').trim()}</div>`;
                                            }
                                        }).join('');
                                    } else {
                                        // Array of strings
                                        return `<ul class="list-disc list-inside mt-1 ml-4">${value.map(item => `<li>${typeof item === 'string' ? item : JSON.stringify(item)}</li>`).join('')}</ul>`;
                                    }
                                } else if (typeof value === 'object' && value !== null) {
                                    // Nested object - render recursively
                                    return Object.entries(value).map(([k, v]) => {
                                        const formattedSubKey = k.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                                        return `<div class="ml-4 mb-2"><span class="font-medium">${formattedSubKey}:</span> ${renderValue(v, k)}</div>`;
                                    }).join('');
                                } else {
                                    return typeof value === 'string' ? value : JSON.stringify(value);
                                }
                            };
                            
                            const objectContent = Object.entries(items).map(([key, value]) => {
                                const formattedKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                                return `<div class="mb-3"><strong>${formattedKey}:</strong><div class="mt-1">${renderValue(value, key)}</div></div>`;
                            }).join('');
                            
                            return `
                                <div class="mb-8">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-4">${title}</h3>
                                    <div class="concept-card ${bgColor} p-4 rounded-lg border-l-4 ${borderColor}">
                                        <div class="text-gray-700">${objectContent}</div>
                                    </div>
                                </div>
                            `;
                        }
                        // If it's a string, render as single item
                        return `
                            <div class="mb-8">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">${title}</h3>
                                <div class="concept-card ${bgColor} p-4 rounded-lg border-l-4 ${borderColor}">
                                    <p class="text-gray-700">${items}</p>
                                </div>
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">${title}</h3>
                            <div class="grid gap-4">
                                ${items.map(item => `
                                    <div class="concept-card ${bgColor} p-4 rounded-lg border-l-4 ${borderColor}">
                                        <p class="text-gray-700">${item}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                };

                const principlesHTML = renderContentList(section.content.keyPrinciples, 'Key Principles');

                // Generate content sections dynamically
                const contentSections = [];

                // Core content sections with flexible rendering  
                const contentMappings = [
                    { key: 'whatIsSNOMEDCT', title: 'What is SNOMED CT?', type: 'list' },
                    { key: 'whyUseSNOMEDCT', title: 'Why Use SNOMED CT?', type: 'list' },
                    { key: 'intendedUse', title: 'Intended Use', type: 'list' },
                    { key: 'domains', title: 'SNOMED CT Domains', type: 'cards', bg: 'bg-blue-50', border: 'border-blue-400' },
                    { key: 'requirements', title: 'SNOMED CT Requirements', type: 'cards', bg: 'bg-purple-50', border: 'border-purple-400' },
                    { key: 'rootConcept', title: 'Root Concept', type: 'special' },
                    { key: 'topLevelConcepts', title: 'Top-level Concepts', type: 'cards', bg: 'bg-indigo-50', border: 'border-indigo-400' },
                    { key: 'attributes', title: 'Attributes', type: 'list' },
                    { key: 'definingCharacteristics', title: 'Defining Characteristics', type: 'list' },
                    { key: 'qualifyingCharacteristics', title: 'Qualifying Characteristics', type: 'list' },
                    { key: 'modelingPhilosophy', title: 'Modeling Philosophy', type: 'cards', bg: 'bg-green-50', border: 'border-green-400' },
                    { key: 'advantages', title: 'Advantages', type: 'list' },
                    { key: 'contentConformance', title: 'Content Conformance', type: 'list' },
                    { key: 'scope', title: 'Scope', type: 'list' },
                    { key: 'articles', title: 'Articles', type: 'list' },
                    { key: 'abbreviations', title: 'Abbreviations', type: 'cards', bg: 'bg-yellow-50', border: 'border-yellow-400' },
                    { key: 'eponyms', title: 'Eponyms', type: 'cards', bg: 'bg-orange-50', border: 'border-orange-400' },
                    { key: 'prepositions', title: 'Prepositions', type: 'list' },
                    { key: 'foundationHierarchies', title: 'Foundation Hierarchies', type: 'list' },
                    { key: 'descriptionTypes', title: 'Description Types', type: 'cards', bg: 'bg-rose-50', border: 'border-rose-400' },
                    { key: 'caseSignificance', title: 'Case Significance', type: 'list' },
                    { key: 'lengthLimitations', title: 'Length Limitations', type: 'cards', bg: 'bg-gray-50', border: 'border-gray-400' },
                    { key: 'annotations', title: 'Annotations', type: 'list' },
                    { key: 'conceptChanges', title: 'Concept Changes', type: 'list' },
                    { key: 'inactivation', title: 'Inactivation', type: 'cards', bg: 'bg-red-50', border: 'border-red-400' },
                    { key: 'conjunctionDisjunction', title: 'Conjunction and Disjunction', type: 'cards', bg: 'bg-amber-50', border: 'border-amber-400' },
                    { key: 'grouperConcepts', title: 'Grouper Concepts', type: 'list' },
                    { key: 'relationshipGroups', title: 'Relationship Groups', type: 'list' },
                    { key: 'sufficiencyDefinition', title: 'Sufficiency Definition', type: 'cards', bg: 'bg-lime-50', border: 'border-lime-400' },
                    { key: 'attributesSummary', title: 'Attributes Summary', type: 'cards', bg: 'bg-teal-50', border: 'border-teal-400' },
                    { key: 'anatomicalModel', title: 'Anatomical Model', type: 'cards', bg: 'bg-cyan-50', border: 'border-cyan-400' },
                    { key: 'morphologicAbnormality', title: 'Morphologic Abnormality', type: 'list' },
                    { key: 'definingAttributes', title: 'Defining Attributes', type: 'cards', bg: 'bg-emerald-50', border: 'border-emerald-400' },
                    { key: 'specificModeling', title: 'Specific Modeling', type: 'cards', bg: 'bg-violet-50', border: 'border-violet-400' },
                    { key: 'procedureCategories', title: 'Procedure Categories', type: 'list' },
                    { key: 'medicinalProduct', title: 'Medicinal Product', type: 'list' },
                    { key: 'doseFormCategories', title: 'Dose Form Categories', type: 'list' },
                    { key: 'strengthRepresentation', title: 'Strength Representation', type: 'list' },
                    { key: 'biologicProducts', title: 'Biologic Products', type: 'cards', bg: 'bg-pink-50', border: 'border-pink-400' },
                    { key: 'qualifierValues', title: 'Qualifier Values', type: 'list' },
                    { key: 'useOfObservables', title: 'Use of Observables', type: 'list' },
                    { key: 'vsEvaluationProcedure', title: 'vs Evaluation Procedure', type: 'cards', bg: 'bg-slate-50', border: 'border-slate-400' },
                    { key: 'organismsWithQualifiers', title: 'Organisms with Qualifiers', type: 'list' },
                    { key: 'validity', title: 'Validity', type: 'list' },
                    { key: 'organismGroupings', title: 'Organism Groupings', type: 'cards', bg: 'bg-green-50', border: 'border-green-400' },
                    { key: 'biotypeSerotype', title: 'Biotype and Serotype', type: 'list' },
                    { key: 'drugResistance', title: 'Drug Resistance', type: 'cards', bg: 'bg-red-50', border: 'border-red-400' },
                    { key: 'substanceCategories', title: 'Substance Categories', type: 'list' },
                    { key: 'variableMeanings', title: 'Variable Meanings', type: 'list' },
                    { key: 'specimenNotSample', title: 'Specimen vs Sample', type: 'cards', bg: 'bg-blue-50', border: 'border-blue-400' },
                    { key: 'combinedSpecimens', title: 'Combined Specimens', type: 'list' },
                    { key: 'validationLevels', title: 'Validation Levels', type: 'cards', bg: 'bg-red-50', border: 'border-red-400' },
                    { key: 'automatedValidation', title: 'Automated Validation', type: 'list' },
                    { key: 'editorialReview', title: 'Editorial Review', type: 'list' },
                    { key: 'qualityMetrics', title: 'Quality Metrics', type: 'list' },
                    { key: 'releaseSchedule', title: 'Release Schedule', type: 'list' },
                    { key: 'versioningPrinciples', title: 'Versioning Principles', type: 'cards', bg: 'bg-emerald-50', border: 'border-emerald-400' },
                    { key: 'changeManagement', title: 'Change Management', type: 'list' },
                    { key: 'releasePackaging', title: 'Release Packaging', type: 'list' },
                    { key: 'keyPrinciples', title: 'Key Principles', type: 'list' },
                    { key: 'corePrinciples', title: 'Core Principles', type: 'list' },
                    { key: 'benefits', title: 'Benefits', type: 'list' },
                    { key: 'componentTypes', title: 'Component Types', type: 'cards', bg: 'bg-indigo-50', border: 'border-indigo-400' },
                    { key: 'hierarchyStructure', title: 'Hierarchy Structure', type: 'cards', bg: 'bg-purple-50', border: 'border-purple-400' },
                    { key: 'relationshipTypes', title: 'Relationship Types', type: 'cards', bg: 'bg-green-50', border: 'border-green-400' },
                    { key: 'modelingPrinciples', title: 'Modeling Principles', type: 'cards' },
                    { key: 'guidelines', title: 'Editorial Guidelines', type: 'cards' },
                    { key: 'namingConventions', title: 'Naming Conventions', type: 'cards', bg: 'bg-yellow-50', border: 'border-yellow-400' },
                    { key: 'definingAttributes', title: 'Defining Attributes', type: 'cards', bg: 'bg-teal-50', border: 'border-teal-400' },
                    { key: 'procedureCategories', title: 'Procedure Categories', type: 'list' },
                    { key: 'structureTypes', title: 'Structure Types', type: 'list' },
                    { key: 'productTypes', title: 'Product Types', type: 'list' },
                    { key: 'doseFormCategories', title: 'Dose Form Categories', type: 'list' },
                    { key: 'doseforms', title: 'Common Dose Forms', type: 'grid' },
                    { key: 'modelingAttributes', title: 'Modeling Attributes', type: 'cards', bg: 'bg-pink-50', border: 'border-pink-400' },
                    { key: 'strengthRepresentation', title: 'Strength Representation', type: 'list' },
                    { key: 'biologicSpecifics', title: 'Biologic Specifics', type: 'cards', bg: 'bg-cyan-50', border: 'border-cyan-400' },
                    { key: 'specialCases', title: 'Special Cases', type: 'cards', bg: 'bg-orange-50', border: 'border-orange-400' },
                    { key: 'governanceStructure', title: 'Governance Structure', type: 'list' },
                    { key: 'qualityAssurance', title: 'Quality Assurance', type: 'list' },
                    { key: 'versionControl', title: 'Version Control', type: 'list' },
                    { key: 'laterality', title: 'Laterality Guidelines', type: 'cards', bg: 'bg-emerald-50', border: 'border-emerald-400' },
                    { key: 'taxonomicPrinciples', title: 'Taxonomic Principles', type: 'list' },
                    { key: 'organismCategories', title: 'Organism Categories', type: 'list' },
                    { key: 'relationshipCategories', title: 'Relationship Categories', type: 'list' },
                    { key: 'coreRelationships', title: 'Core Relationships', type: 'cards', bg: 'bg-violet-50', border: 'border-violet-400' },
                    { key: 'modelingRules', title: 'Modeling Rules', type: 'cards' },
                    { key: 'refinement', title: 'Refinement Techniques', type: 'cards', bg: 'bg-lime-50', border: 'border-lime-400' },
                    { key: 'bestPractices', title: 'Best Practices', type: 'practices' },
                    { key: 'modeling', title: 'Best Practices', type: 'practices' },
                    { key: 'descriptionTypes', title: 'Description Types', type: 'cards', bg: 'bg-rose-50', border: 'border-rose-400' },
                    { key: 'fsnGuidelines', title: 'FSN Guidelines', type: 'cards' },
                    { key: 'semanticTags', title: 'Semantic Tags', type: 'list' },
                    { key: 'languageSupport', title: 'Language Support', type: 'list' },
                    { key: 'referenceSetTypes', title: 'Reference Set Types', type: 'cards', bg: 'bg-slate-50', border: 'border-slate-400' },
                    { key: 'languageReferenceSets', title: 'Language Reference Sets', type: 'list' },
                    { key: 'mappingReferenceSets', title: 'Mapping Reference Sets', type: 'list' },
                    { key: 'validationLevels', title: 'Validation Levels', type: 'cards', bg: 'bg-red-50', border: 'border-red-400' },
                    { key: 'automatedValidation', title: 'Automated Validation', type: 'list' },
                    { key: 'editorialReview', title: 'Editorial Review', type: 'list' },
                    { key: 'qualityMetrics', title: 'Quality Metrics', type: 'list' },
                    { key: 'continuousImprovement', title: 'Continuous Improvement', type: 'list' },
                    { key: 'expressionStructure', title: 'Expression Structure', type: 'cards', bg: 'bg-amber-50', border: 'border-amber-400' },
                    { key: 'syntaxElements', title: 'Syntax Elements', type: 'cards', bg: 'bg-gray-50', border: 'border-gray-400' },
                    { key: 'commonPatterns', title: 'Common Patterns', type: 'list' },
                    { key: 'implementationPhases', title: 'Implementation Phases', type: 'cards', bg: 'bg-sky-50', border: 'border-sky-400' },
                    { key: 'technicalConsiderations', title: 'Technical Considerations', type: 'list' },
                    { key: 'clinicalConsiderations', title: 'Clinical Considerations', type: 'list' },
                    { key: 'maintenanceRequirements', title: 'Maintenance Requirements', type: 'list' },
                    { key: 'releaseSchedule', title: 'Release Schedule', type: 'list' },
                    { key: 'versioningPrinciples', title: 'Versioning Principles', type: 'cards', bg: 'bg-emerald-50', border: 'border-emerald-400' },
                    { key: 'changeManagement', title: 'Change Management', type: 'list' },
                    { key: 'releasePackaging', title: 'Release Packaging', type: 'list' },
                    { key: 'migrationSupport', title: 'Migration Support', type: 'list' }
                ];

                contentMappings.forEach(mapping => {
                    const content = section.content[mapping.key];
                    if (content) {
                        switch (mapping.type) {
                            case 'list':
                                contentSections.push(renderContentList(content, mapping.title));
                                break;
                            case 'cards':
                                contentSections.push(renderContentCards(content, mapping.title, mapping.bg, mapping.border));
                                break;
                            case 'grid':
                                if (Array.isArray(content)) {
                                    contentSections.push(`
                                        <div class="mb-8">
                                            <h3 class="text-xl font-semibold text-gray-800 mb-4">${mapping.title}</h3>
                                            <div class="grid md:grid-cols-2 gap-3">
                                                ${content.map(item => `
                                                    <div class="bg-purple-50 p-3 rounded-lg">
                                                        <span class="text-gray-700">${item}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `);
                                } else {
                                    // Fall back to cards rendering for non-arrays
                                    contentSections.push(renderContentCards(content, mapping.title, 'bg-purple-50', 'border-purple-400'));
                                }
                                break;
                            case 'practices':
                                if (Array.isArray(content)) {
                                    contentSections.push(`
                                        <div class="mb-8">
                                            <h3 class="text-xl font-semibold text-gray-800 mb-4">${mapping.title}</h3>
                                            <div class="space-y-3">
                                                ${content.map(practice => `
                                                    <div class="flex items-start space-x-3 p-3 bg-green-50 rounded-lg">
                                                        <span class="material-icons text-green-600 text-sm mt-0.5">lightbulb</span>
                                                        <span class="text-gray-700">${practice}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `);
                                } else {
                                    // Fall back to cards rendering for non-arrays
                                    contentSections.push(renderContentCards(content, mapping.title, 'bg-green-50', 'border-green-400'));
                                }
                                break;
                            case 'special':
                                if (mapping.key === 'hrcm') {
                                    // Special rendering for HRCM with dynamic data fetching
                                    const placeholderId = 'hrcm-content-' + Math.random().toString(36).substr(2, 9);
                                    
                                    contentSections.push(`
                                        <div class="mb-8" id="${placeholderId}">
                                            <h3 class="text-xl font-semibold text-gray-800 mb-4">${mapping.title}</h3>
                                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                                                                                 <div class="flex items-center space-x-2">
                                                     <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                                                     <p class="text-sm text-blue-700">Loading real-time MRCM data from refset 723561005...</p>
                                                 </div>
                                                 <p class="text-xs text-blue-600 mt-2">Server: ${SNOMED_CONFIG.baseUrl}/${SNOMED_CONFIG.branch}</p>
                                            </div>
                                        </div>
                                    `);
                                    
                                    // Fetch dynamic HRCM data asynchronously
                                    setTimeout(async () => {
                                        const placeholder = document.getElementById(placeholderId);
                                        if (!placeholder) return;
                                        
                                        try {
                                            const hrcmData = await mrcmService.getHRCMData('404684003', 'Clinical finding (finding)');
                                            
                                                                                         if (hrcmData && hrcmData.attributes) {
                                                 // Render with live data
                                                 placeholder.innerHTML = `
                                                     <h3 class="text-xl font-semibold text-gray-800 mb-4">${mapping.title}</h3>
                                                     <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                                         <div class="flex items-center space-x-2 mb-2">
                                                             <span class="material-icons text-green-600 text-sm">check_circle</span>
                                                             <p class="text-sm text-green-800 font-medium">Live Data Retrieved</p>
                                                         </div>
                                                         <p class="text-sm text-green-700 mb-2"><strong>Version:</strong> ${hrcmData.version}</p>
                                                         <p class="text-sm text-green-700 mb-2">${hrcmData.description}</p>
                                                         <p class="text-sm text-green-700 mb-2"><strong>Domain Constraint:</strong> <code class="bg-green-100 px-1 rounded">${hrcmData.domainConstraint}</code></p>
                                                         <p class="text-sm text-green-700 mb-2"><strong>Server:</strong> <a href="${hrcmData.sourceUrl}" target="_blank" class="text-green-600 hover:text-green-800 underline">${hrcmData.serverInfo.baseUrl}</a></p>
                                                         <p class="text-xs text-green-600 mb-1"><strong>MRCM Refset:</strong> ${hrcmData.serverInfo.refsetId} (${hrcmData.serverInfo.attributeCount} attributes)</p>
                                                         <p class="text-xs text-green-600"><strong>Last Updated:</strong> ${new Date(hrcmData.serverInfo.lastFetched).toLocaleString()}</p>
                                                         <div class="mt-3 pt-3 border-t border-green-200">
                                                             <button onclick="window.refreshHRCM('${placeholderId}')" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded mr-2">
                                                                 <span class="material-icons text-xs mr-1">refresh</span>Refresh Data
                                                             </button>
                                                             <button onclick="window.configureHRCM()" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded">
                                                                 <span class="material-icons text-xs mr-1">settings</span>Configure Server
                                                             </button>
                                                         </div>
                                                     </div>
                                                    <div class="overflow-x-auto">
                                                        <table class="w-full border-collapse border border-gray-300 bg-white text-sm">
                                                            <thead>
                                                                <tr class="bg-gray-100">
                                                                    <th class="border border-gray-300 px-3 py-2 text-left font-semibold">Attribute</th>
                                                                    <th class="border border-gray-300 px-3 py-2 text-left font-semibold">ID</th>
                                                                    <th class="border border-gray-300 px-3 py-2 text-left font-semibold">Grouped</th>
                                                                    <th class="border border-gray-300 px-3 py-2 text-left font-semibold">Cardinality</th>
                                                                    <th class="border border-gray-300 px-3 py-2 text-left font-semibold">In Group</th>
                                                                    <th class="border border-gray-300 px-3 py-2 text-left font-semibold">Range Constraint</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                ${hrcmData.attributes.map(attr => `
                                                                    <tr class="hover:bg-gray-50">
                                                                        <td class="border border-gray-300 px-3 py-2 font-medium">${attr.name}</td>
                                                                        <td class="border border-gray-300 px-3 py-2 font-mono text-xs text-gray-600">${attr.id}</td>
                                                                        <td class="border border-gray-300 px-3 py-2 text-center">${attr.grouped}</td>
                                                                        <td class="border border-gray-300 px-3 py-2 text-center font-mono text-xs">${attr.cardinality}</td>
                                                                        <td class="border border-gray-300 px-3 py-2 text-center font-mono text-xs">${attr.inGroupCardinality}</td>
                                                                        <td class="border border-gray-300 px-3 py-2 text-xs">${attr.range}</td>
                                                                    </tr>
                                                                `).join('')}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                `;
                                            } else {
                                                throw new Error('No MRCM data received');
                                            }
                                        } catch (error) {
                                            console.error('Failed to load live MRCM data, falling back to static data:', error);
                                            
                                            // Fallback to static data
                                            if (typeof content === 'object' && content.attributes) {
                                                placeholder.innerHTML = `
                                                    <h3 class="text-xl font-semibold text-gray-800 mb-4">${mapping.title}</h3>
                                                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                                                        <div class="flex items-center space-x-2 mb-2">
                                                            <span class="material-icons text-yellow-600 text-sm">warning</span>
                                                            <p class="text-sm text-yellow-800 font-medium">Using Static Data (Server Unavailable)</p>
                                                        </div>
                                                        <p class="text-sm text-yellow-700 mb-2"><strong>Version:</strong> ${content.version}</p>
                                                        <p class="text-sm text-yellow-700 mb-2">${content.description}</p>
                                                        <p class="text-sm text-yellow-700 mb-2"><strong>Domain Constraint:</strong> <code class="bg-yellow-100 px-1 rounded">${content.domainConstraint}</code></p>
                                                        <p class="text-sm text-yellow-700"><strong>Source:</strong> <a href="${content.sourceUrl}" target="_blank" class="text-yellow-600 hover:text-yellow-800 underline">SNOMED International HRCM Documentation</a></p>
                                                        <p class="text-xs text-yellow-600 mt-2">Unable to connect to terminology server: ${SNOMED_CONFIG.baseUrl}</p>
                                                    </div>
                                                    <div class="overflow-x-auto">
                                                        <table class="w-full border-collapse border border-gray-300 bg-white text-sm">
                                                            <thead>
                                                                <tr class="bg-gray-100">
                                                                    <th class="border border-gray-300 px-3 py-2 text-left font-semibold">Attribute</th>
                                                                    <th class="border border-gray-300 px-3 py-2 text-left font-semibold">ID</th>
                                                                    <th class="border border-gray-300 px-3 py-2 text-left font-semibold">Grouped</th>
                                                                    <th class="border border-gray-300 px-3 py-2 text-left font-semibold">Cardinality</th>
                                                                    <th class="border border-gray-300 px-3 py-2 text-left font-semibold">In Group</th>
                                                                    <th class="border border-gray-300 px-3 py-2 text-left font-semibold">Range Constraint</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                ${content.attributes.map(attr => `
                                                                    <tr class="hover:bg-gray-50">
                                                                        <td class="border border-gray-300 px-3 py-2 font-medium">${attr.name}</td>
                                                                        <td class="border border-gray-300 px-3 py-2 font-mono text-xs text-gray-600">${attr.id}</td>
                                                                        <td class="border border-gray-300 px-3 py-2 text-center">${attr.grouped}</td>
                                                                        <td class="border border-gray-300 px-3 py-2 text-center font-mono text-xs">${attr.cardinality}</td>
                                                                        <td class="border border-gray-300 px-3 py-2 text-center font-mono text-xs">${attr.inGroupCardinality}</td>
                                                                        <td class="border border-gray-300 px-3 py-2 text-xs">${attr.range}</td>
                                                                    </tr>
                                                                `).join('')}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                `;
                                            } else {
                                                placeholder.innerHTML = `
                                                    <h3 class="text-xl font-semibold text-gray-800 mb-4">${mapping.title}</h3>
                                                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                                        <div class="flex items-center space-x-2 mb-2">
                                                            <span class="material-icons text-red-600 text-sm">error</span>
                                                            <p class="text-sm text-red-800 font-medium">Failed to Load HRCM Data</p>
                                                        </div>
                                                        <p class="text-sm text-red-700">Unable to connect to terminology server and no static fallback data available.</p>
                                                        <p class="text-xs text-red-600 mt-2">Server: ${SNOMED_CONFIG.baseUrl}</p>
                                                    </div>
                                                `;
                                            }
                                        }
                                    }, 100);
                                } else {
                                    // Default special rendering
                                    contentSections.push(`
                                        <div class="mb-8">
                                            <h3 class="text-xl font-semibold text-gray-800 mb-4">${mapping.title}</h3>
                                            <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                                                <p class="text-gray-700 font-mono text-sm">${content}</p>
                                            </div>
                                        </div>
                                    `);
                                }
                                break;
                        }
                    }
                });

                // Add HRCM section for concept hierarchies
                if (SNOMED_CONFIG.domainIds[section.id]) {
                    const placeholderId = 'hrcm-content-' + section.id + '-' + Math.random().toString(36).substr(2, 9);
                    
                    contentSections.push(`
                        <div class="mb-8" id="${placeholderId}">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Human Readable Concept Model (HRCM)</h3>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                <div class="flex items-center space-x-2">
                                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                                    <p class="text-sm text-blue-700">Loading real-time MRCM data from refset 723561005...</p>
                                </div>
                                <p class="text-xs text-blue-600 mt-2">Server: ${SNOMED_CONFIG.baseUrl}/${SNOMED_CONFIG.branch}</p>
                            </div>
                        </div>
                    `);
                    
                    // Fetch dynamic HRCM data asynchronously
                    setTimeout(async () => {
                        const placeholder = document.getElementById(placeholderId);
                        if (!placeholder) return;
                        
                        const domainId = SNOMED_CONFIG.domainIds[section.id];
                        const domainName = section.title.replace(' Concepts', '');
                        
                        try {
                            const hrcmData = await mrcmService.getHRCMData(domainId, domainName);
                            
                            if (hrcmData && hrcmData.attributes) {
                                // Render with live data
                                placeholder.innerHTML = `
                                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Human Readable Concept Model (HRCM)</h3>
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="material-icons text-green-600 text-sm">check_circle</span>
                                            <p class="text-sm text-green-800 font-medium">Live Data Retrieved</p>
                                        </div>
                                        <p class="text-sm text-green-700 mb-2"><strong>Version:</strong> ${hrcmData.version}</p>
                                        <p class="text-sm text-green-700 mb-2">${hrcmData.description}</p>
                                        <p class="text-sm text-green-700 mb-2"><strong>Domain Constraint:</strong> <code class="bg-green-100 px-1 rounded">${hrcmData.domainConstraint}</code></p>
                                        <p class="text-sm text-green-700 mb-2"><strong>Server:</strong> <a href="${hrcmData.sourceUrl}" target="_blank" class="text-green-600 hover:text-green-800 underline">${hrcmData.serverInfo.baseUrl}</a></p>
                                        <p class="text-xs text-green-600 mb-1"><strong>MRCM Refset:</strong> ${hrcmData.serverInfo.refsetId} (${hrcmData.serverInfo.attributeCount} attributes)</p>
                                        <p class="text-xs text-green-600"><strong>Last Updated:</strong> ${new Date(hrcmData.serverInfo.lastFetched).toLocaleString()}</p>
                                        <div class="mt-3 pt-3 border-t border-green-200">
                                            <button onclick="window.refreshHRCM('${placeholderId}', '${section.id}')" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded mr-2">
                                                <span class="material-icons text-xs mr-1">refresh</span>Refresh Data
                                            </button>
                                            <button onclick="window.configureHRCM()" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded">
                                                <span class="material-icons text-xs mr-1">settings</span>Configure Server
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <h4 class="text-lg font-medium text-gray-800 mb-2">${domainName} Domain Attributes</h4>
                                        <p class="text-sm text-gray-600">MRCM constraints for domain ${domainId} |${domainName}|</p>
                                    </div>
                                    <div class="overflow-x-auto">
                                        <table class="w-full border-collapse border border-gray-300 bg-white text-sm">
                                            <thead>
                                                <tr class="bg-gray-100">
                                                    <th class="border border-gray-300 px-3 py-2 text-left font-semibold">Attribute</th>
                                                    <th class="border border-gray-300 px-3 py-2 text-left font-semibold">SNOMED CT ID</th>
                                                    <th class="border border-gray-300 px-3 py-2 text-left font-semibold">Grouped</th>
                                                    <th class="border border-gray-300 px-3 py-2 text-left font-semibold">Cardinality</th>
                                                    <th class="border border-gray-300 px-3 py-2 text-left font-semibold">In Group</th>
                                                    <th class="border border-gray-300 px-3 py-2 text-left font-semibold">Range Constraint</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${hrcmData.attributes.map(attr => `
                                                    <tr class="hover:bg-gray-50">
                                                        <td class="border border-gray-300 px-3 py-2 font-medium">${attr.name}</td>
                                                        <td class="border border-gray-300 px-3 py-2 font-mono text-xs text-gray-600">${attr.id}</td>
                                                        <td class="border border-gray-300 px-3 py-2 text-center">${attr.grouped}</td>
                                                        <td class="border border-gray-300 px-3 py-2 text-center font-mono text-xs">${attr.cardinality}</td>
                                                        <td class="border border-gray-300 px-3 py-2 text-center font-mono text-xs">${attr.inGroupCardinality}</td>
                                                        <td class="border border-gray-300 px-3 py-2 text-xs">${attr.range}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                `;
                            } else {
                                throw new Error('No MRCM data received');
                            }
                        } catch (error) {
                            console.error(`Failed to load live MRCM data for ${domainName}, falling back to error display:`, error);
                            
                            placeholder.innerHTML = `
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">Human Readable Concept Model (HRCM)</h3>
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <span class="material-icons text-yellow-600 text-sm">warning</span>
                                        <p class="text-sm text-yellow-800 font-medium">Unable to Load MRCM Data</p>
                                    </div>
                                    <p class="text-sm text-yellow-700 mb-2">Could not fetch MRCM constraints for ${domainName} domain (${domainId})</p>
                                    <p class="text-xs text-yellow-600 mt-2">Server: ${SNOMED_CONFIG.baseUrl}</p>
                                    <div class="mt-3 pt-3 border-t border-yellow-200">
                                        <button onclick="window.refreshHRCM('${placeholderId}', '${section.id}')" class="bg-yellow-600 hover:bg-yellow-700 text-white text-xs px-3 py-1 rounded mr-2">
                                            <span class="material-icons text-xs mr-1">refresh</span>Try Again
                                        </button>
                                        <button onclick="window.configureHRCM()" class="bg-yellow-600 hover:bg-yellow-700 text-white text-xs px-3 py-1 rounded">
                                            <span class="material-icons text-xs mr-1">settings</span>Configure Server
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    }, 100);
                }

                const updatesHTML = section.content.updates ? `
                    <div class="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="flex items-start space-x-2">
                            <span class="material-icons text-yellow-600">info</span>
                            <p class="text-gray-700">${section.content.updates}</p>
                        </div>
                    </div>
                ` : '';

                // Enhanced examples with interactive features (skip for clinical finding as it has specialized rendering)
                const examplesHTML = section.content.examples && section.id !== 'clinical-finding' ? `
                    <div class="collapsible-section mb-8">
                        <div class="collapsible-header" onclick="app.toggleSection('examples-${section.id}')">
                            <h3 class="text-xl font-semibold text-gray-800">Examples</h3>
                            <span class="material-icons expand-icon" id="examples-${section.id}-icon">expand_more</span>
                        </div>
                        <div class="collapsible-content" id="examples-${section.id}-content">
                            <div class="grid gap-4">
                                ${Array.isArray(section.content.examples) ? section.content.examples.map((example, index) => {
                                    if (typeof example === 'object' && example.scenario) {
                                        // Handle clinical finding examples format
                                        return `
                                            <div class="example-card">
                                                <div class="example-tag">Example ${index + 1}</div>
                                                <h4 class="font-semibold text-gray-800 text-lg mb-2">${example.scenario}</h4>
                                                <p class="text-gray-700 mb-2">${example.description}</p>
                                                ${example.details ? `
                                                    <ul class="list-disc list-inside space-y-1 text-gray-700 ml-4">
                                                        ${example.details.map(detail => `<li>${detail}</li>`).join('')}
                                                    </ul>
                                                ` : ''}
                                            </div>
                                        `;
                                    } else if (typeof example === 'object' && example.concept) {
                                        // Handle standard examples format
                                        return `
                                            <div class="example-card">
                                                <div class="example-tag">Example ${index + 1}</div>
                                                <div class="flex justify-between items-start mb-3">
                                                    <h4 class="font-semibold text-gray-800 text-lg">${this.linkifyText(example.concept)}</h4>
                                                    ${example.id ? `<span class="concept-id" onclick="app.showConceptDetails('${example.id}')">${example.id}</span>` : ''}
                                                </div>
                                                ${example.hierarchy ? `
                                                    <div class="hierarchy-path">
                                                        ${this.createHierarchyLinks(example.hierarchy)}
                                                    </div>
                                                ` : ''}
                                                ${example.attributes ? `
                                                    <div class="mt-3 p-3 bg-blue-50 rounded-lg">
                                                        <h5 class="font-medium text-blue-800 mb-2">Attributes:</h5>
                                                        <p class="text-sm text-blue-700">${this.linkifyText(example.attributes)}</p>
                                                    </div>
                                                ` : ''}
                                                ${example.expression ? `
                                                    <div class="mt-3">
                                                        <h5 class="font-medium text-gray-800 mb-2">Expression:</h5>
                                                        <div class="p-3 bg-gray-50 rounded-lg text-sm font-mono text-gray-700">
                                                            ${this.linkifyExpression(example.expression)}
                                                        </div>
                                                        <p class="text-sm text-gray-600 mt-2">${example.description}</p>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `;
                                    } else {
                                        // Handle string examples
                                        return `
                                            <div class="example-card">
                                                <div class="example-tag">Example ${index + 1}</div>
                                                <p class="text-gray-700">${typeof example === 'string' ? this.linkifyText(example) : JSON.stringify(example)}</p>
                                            </div>
                                        `;
                                    }
                                }).join('') : '<div class="p-4 bg-gray-50 rounded-lg text-gray-600">Examples are available in a different format for this section.</div>'}
                            </div>
                        </div>
                    </div>
                ` : '';

                // Special handling for version history
                const versionHistoryHTML = section.content.versionHistory ? `
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Version History</h3>
                        <div class="space-y-4">
                            ${section.content.versionHistory.map(version => `
                                <div class="border-l-4 border-blue-400 pl-4 py-3 bg-blue-50 rounded-r-lg">
                                    <div class="font-semibold text-gray-800 mb-1">${version.version}</div>
                                    <div class="text-gray-600 mb-2">${version.changes}</div>
                                    ${version.significance ? `<div class="text-sm text-blue-600 font-medium">${version.significance}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '';

                content.innerHTML = `
                    <div class="space-y-8">
                        <!-- Breadcrumb Navigation -->
                        <div class="breadcrumb-nav">
                            <span class="breadcrumb-link" onclick="app.selectSection('introduction')">
                                <span class="material-icons text-sm mr-1">home</span>Guide Home
                            </span>
                            <span class="mx-2 text-gray-400">‚Ä∫</span>
                            <span class="text-gray-700 font-medium">${section.title}</span>
                        </div>

                        <!-- Section Header -->
                        <div class="bg-white rounded-lg shadow-md p-8">
                            <div class="flex items-start space-x-4">
                                <span class="material-icons text-4xl text-blue-600">${section.icon}</span>
                                <div class="flex-1">
                                    <h2 class="text-3xl font-bold text-gray-800 mb-2">${section.title}</h2>
                                    <p class="text-gray-600 text-lg mb-4">${section.description}</p>
                                    
                                    <!-- Navigation buttons -->
                                    <div class="flex gap-3">
                                        <button id="prevButton" onclick="app.navigateToPrevious()" class="flex items-center px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                            <span class="material-icons text-sm mr-1">arrow_back</span>Previous
                                        </button>
                                        <button id="nextButton" onclick="app.navigateToNext()" class="flex items-center px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                            Next<span class="material-icons text-sm ml-1">arrow_forward</span>
                                        </button>
                                        <button onclick="app.copyCurrentSectionLink()" class="flex items-center px-3 py-2 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg text-sm font-medium transition-colors">
                                            <span class="material-icons text-sm mr-1">link</span>Copy Link
                                        </button>
                                        <button onclick="window.print()" class="flex items-center px-3 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-sm font-medium transition-colors">
                                            <span class="material-icons text-sm mr-1">print</span>Print
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cross References -->
                        ${this.addCrossReferences(section.id)}

                        <!-- Section Content -->
                        <div class="bg-white rounded-lg shadow-md p-8">
                            <!-- Overview -->
                            <div class="mb-8">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">Overview</h3>
                                <p class="text-gray-700 leading-relaxed">${this.linkifyText(section.content.overview)}</p>
                            </div>

                            <!-- Hierarchy Statistics (for specific sections) -->
                            ${this.renderHierarchyStats(section.id)}

                            <!-- Statistics Dashboard (for introduction section) -->
                            ${section.id === 'introduction' ? this.renderStatistics() : ''}

                            <!-- Enhanced Content Sections -->
                            ${this.renderEnhancedContent(section)}

                            ${section.content.semanticInteroperability ? `
                                <div class="mb-8">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Semantic Interoperability</h3>
                                    <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                        <p class="text-gray-700">${this.linkifyText(section.content.semanticInteroperability)}</p>
                                    </div>
                                </div>
                            ` : ''}

                            ${contentSections.join('')}
                            ${examplesHTML}
                            ${versionHistoryHTML}
                            ${updatesHTML}
                            ${section.content.recentChanges ? `
                                <div class="mt-8 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                                    <div class="flex items-start space-x-2">
                                        <span class="material-icons text-indigo-600">update</span>
                                        <div>
                                            <h4 class="font-semibold text-indigo-800 mb-1">Recent Changes</h4>
                                            <p class="text-gray-700">${this.linkifyText(section.content.recentChanges)}</p>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Quick Actions -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="font-semibold text-gray-800 mb-3">Quick Actions</h4>
                            <div class="flex flex-wrap gap-3">
                                <button onclick="document.getElementById('searchInput').focus()" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors">
                                    <span class="material-icons text-sm mr-1">search</span>Search Guide (Ctrl+K)
                                </button>
                                <button onclick="app.selectSection('introduction')" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors">
                                    <span class="material-icons text-sm mr-1">home</span>Back to Start
                                </button>
                                <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-colors">
                                    <span class="material-icons text-sm mr-1">keyboard_arrow_up</span>Back to Top
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderSearchResults() {
                const content = document.getElementById('content');
                const results = guideData.searchResults;
                
                // Scroll to top when showing search results
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                if (results.length === 0) {
                    content.innerHTML = `
                        <div class="content-area p-12 text-center animate-slide-in">
                            <div class="flex items-center justify-center w-24 h-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full mx-auto mb-6 shadow-lg">
                                <span class="material-icons text-gray-400 text-5xl">search_off</span>
                            </div>
                            <h2 class="text-3xl font-bold text-gray-700 mb-4">No results found</h2>
                            <p class="text-gray-500 text-lg max-w-md mx-auto">Try adjusting your search terms or browse the sections below.</p>
                        </div>
                    `;
                    return;
                }
                
                const resultsHTML = results.map(result => `
                    <div class="bg-white rounded-xl shadow-md p-6 mb-6 hover:shadow-xl transition-all duration-300 cursor-pointer concept-card border border-gray-100"
                         onclick="app.selectSection('${result.id}')">
                        <div class="flex items-start">
                            <div class="flex items-center justify-center w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg mr-4 shadow-md">
                                <span class="material-icons text-white text-xl">${result.matchType === 'content' ? 'description' : 'article'}</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center mb-2">
                                    <h3 class="text-xl font-bold text-gray-800">${result.title}</h3>
                                    ${result.category ? `<span class="ml-3 bg-gray-100 text-gray-600 px-2 py-1 rounded text-sm">${result.category}</span>` : ''}
                                    <span class="ml-auto bg-gradient-to-r from-blue-100 to-blue-200 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                                        ${result.matchType === 'content' ? 'Content Match' : 'Title Match'}
                                    </span>
                                </div>
                                ${result.description ? `<p class="text-gray-600 mb-3 leading-relaxed">${result.description}</p>` : ''}
                                ${result.contentPreview ? `
                                    <div class="bg-gray-50 rounded-lg p-3 mb-3">
                                        <p class="text-sm text-gray-700 leading-relaxed">${result.contentPreview}</p>
                                    </div>
                                ` : ''}
                                <div class="flex items-center justify-between">
                                    <span class="bg-gradient-to-r from-green-100 to-green-200 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                                        Relevance: ${result.relevance}
                                    </span>
                                    <span class="text-gray-400 text-sm">Click to view full content</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                content.innerHTML = `
                    <div class="content-area p-8 animate-slide-in">
                        <div class="flex items-center mb-8 pb-6 border-b border-gray-200">
                            <div class="flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl mr-6 shadow-lg">
                                <span class="material-icons text-white text-3xl">search</span>
                            </div>
                            <div>
                                <h1 class="text-4xl font-bold text-gray-800 m-0 mb-2">Search Results</h1>
                                <p class="text-gray-600 text-lg">Found ${results.length} result${results.length !== 1 ? 's' : ''}</p>
                            </div>
                        </div>
                        <div class="search-results">
                            ${resultsHTML}
                        </div>
                    </div>
                `;
            },

            // Main selectSection function - simple implementation without infinite scroll
            selectSection(sectionId) {
                guideData.currentSection = sectionId;
                guideData.searchResults = [];
                document.getElementById('searchInput').value = '';
                
                // Update URL FIRST before rendering content
                this.updateURL(sectionId);
                
                // Then render sidebar and content
                this.renderSidebar();
                this.renderContent();
                this.updateActiveNavItem();
                
                // Smooth scroll to top with animation
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Add entrance animation
                setTimeout(() => {
                    const content = document.getElementById('content');
                    content.classList.add('animate-slide-in');
                    setTimeout(() => content.classList.remove('animate-slide-in'), 300);
                }, 100);
            },

            async search(query) {
                if (!query.trim()) {
                    guideData.searchResults = [];
                    // Scroll to top when clearing search results
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    this.renderContent();
                    return;
                }

                // Show loading state
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="content-area p-12 text-center animate-slide-in">
                        <div class="flex items-center justify-center w-24 h-24 bg-gradient-to-br from-blue-100 to-blue-200 rounded-full mx-auto mb-6 shadow-lg">
                            <div class="loading-spinner"></div>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">Searching...</h2>
                        <p class="text-gray-500">Searching through ${guideData.sections.length} sections</p>
                    </div>
                `;

                const results = [];
                const queryLower = query.toLowerCase();

                // First pass: search titles, descriptions, and categories
                for (const section of guideData.sections) {
                    const titleMatch = section.title.toLowerCase().includes(queryLower);
                    const descriptionMatch = section.description && section.description.toLowerCase().includes(queryLower);
                    const categoryMatch = section.category && section.category.toLowerCase().includes(queryLower);
                    
                    if (titleMatch || descriptionMatch || categoryMatch) {
                        results.push({
                            ...section,
                            relevance: this.calculateRelevance(section, query),
                            matchType: 'metadata'
                        });
                    }
                }

                // Second pass: search within markdown content (limited to first 10 results for performance)
                const contentSearchPromises = guideData.sections.slice(0, 10).map(async (section) => {
                    try {
                        if (section.mdFile) {
                            const response = await fetch(section.mdFile);
                            if (response.ok) {
                                const content = await response.text();
                                if (content.toLowerCase().includes(queryLower)) {
                                    return {
                                        ...section,
                                        relevance: this.calculateContentRelevance(content, query),
                                        matchType: 'content',
                                        contentPreview: this.generateContentPreview(content, query)
                                    };
                                }
                            }
                        }
                    } catch (error) {
                        console.warn(`Failed to search content in ${section.id}:`, error);
                    }
                    return null;
                });

                const contentResults = await Promise.all(contentSearchPromises);
                const validContentResults = contentResults.filter(result => result !== null);

                // Combine and deduplicate results
                const allResults = [...results, ...validContentResults];
                const uniqueResults = this.deduplicateResults(allResults);

                guideData.searchResults = uniqueResults.sort((a, b) => b.relevance - a.relevance);
                this.renderContent();
            },

            calculateRelevance(section, query) {
                let score = 0;
                const queryLower = query.toLowerCase();
                
                // Title matches get highest score
                if (section.title.toLowerCase().includes(queryLower)) score += 10;
                
                // Description matches
                if (section.description && section.description.toLowerCase().includes(queryLower)) score += 5;
                
                // Category matches
                if (section.category && section.category.toLowerCase().includes(queryLower)) score += 3;
                
                // Exact title match gets bonus
                if (section.title.toLowerCase() === queryLower) score += 5;
                
                // Partial word matches in title
                const titleWords = section.title.toLowerCase().split(/\s+/);
                const queryWords = queryLower.split(/\s+/);
                queryWords.forEach(word => {
                    if (titleWords.some(titleWord => titleWord.includes(word))) {
                        score += 2;
                    }
                });
                
                return score;
            },

            calculateContentRelevance(content, query) {
                let score = 0;
                const queryLower = query.toLowerCase();
                const contentLower = content.toLowerCase();
                
                // Count occurrences of query in content
                const matches = (contentLower.match(new RegExp(queryLower, 'g')) || []).length;
                score += matches * 2;
                
                // Bonus for matches in headings
                const headingMatches = (contentLower.match(new RegExp(`^#{1,6}\\s+.*${queryLower}`, 'gm')) || []).length;
                score += headingMatches * 5;
                
                // Bonus for matches in code blocks
                const codeMatches = (contentLower.match(new RegExp('```[\\s\\S]*?' + queryLower + '[\\s\\S]*?```', 'g')) || []).length;
                score += codeMatches * 3;
                
                return score;
            },

            generateContentPreview(content, query) {
                const queryLower = query.toLowerCase();
                const contentLower = content.toLowerCase();
                const index = contentLower.indexOf(queryLower);
                
                if (index === -1) return '';
                
                const start = Math.max(0, index - 100);
                const end = Math.min(content.length, index + 100);
                let preview = content.substring(start, end);
                
                // Clean up preview
                preview = preview.replace(/^[^\n]*\n/, ''); // Remove first partial line
                preview = preview.replace(/\n[^\n]*$/, ''); // Remove last partial line
                
                // Highlight the query
                const regex = new RegExp(`(${query})`, 'gi');
                preview = preview.replace(regex, '<mark class="bg-yellow-200 px-1 rounded">$1</mark>');
                
                return preview.length > 200 ? preview.substring(0, 200) + '...' : preview;
            },

            deduplicateResults(results) {
                const seen = new Set();
                return results.filter(result => {
                    if (seen.has(result.id)) {
                        return false;
                    }
                    seen.add(result.id);
                    return true;
                });
            },

            // AI Chat Functions
            openAiChat() {
                document.getElementById('aiChatModal').classList.remove('hidden');
                document.getElementById('chatInput').focus();
            },

            closeAiChat() {
                document.getElementById('aiChatModal').classList.add('hidden');
                document.getElementById('chatInput').value = '';
            },

            async sendAiMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (!message) return;
                
                // Add user message to chat
                this.addChatMessage(message, 'user');
                input.value = '';
                
                // Show typing indicator
                this.addTypingIndicator();
                
                try {
                    // Get AI response
                    const response = await this.getAiResponse(message);
                    this.removeTypingIndicator();
                    this.addChatMessage(response, 'ai');
                } catch (error) {
                    this.removeTypingIndicator();
                    this.addChatMessage('Sorry, I encountered an error while processing your request. Please try again.', 'ai');
                }
            },

            addChatMessage(message, sender) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start space-x-3';
                
                if (sender === 'user') {
                    messageDiv.innerHTML = `
                        <div class="flex-1"></div>
                        <div class="bg-blue-600 text-white rounded-lg p-4 max-w-[80%]">
                            <p>${this.escapeHtml(message)}</p>
                        </div>
                        <div class="w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="material-icons text-white text-sm">person</span>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="material-icons text-white text-sm">smart_toy</span>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4 max-w-[85%]">
                            <div class="text-gray-800 prose prose-sm max-w-none">${this.formatAiResponse(message)}</div>
                        </div>
                    `;
                }
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            },

            addTypingIndicator() {
                const chatMessages = document.getElementById('chatMessages');
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typingIndicator';
                typingDiv.className = 'flex items-start space-x-3';
                typingDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="material-icons text-white text-sm">smart_toy</span>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-4 max-w-[85%]">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                `;
                chatMessages.appendChild(typingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            },

            removeTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            },

            async getAiResponse(message) {
                try {
                    // Use Gemini service if available, otherwise fall back to local AI
                    if (geminiService && geminiService.isConfigured()) {
                        // Search for relevant content to provide context
                        const contextData = await geminiService.searchGuideContent(message);
                        
                        // Generate response using Gemini
                        const geminiResponse = await geminiService.generateResponse(message, contextData);
                        
                        if (geminiResponse.success) {
                            return geminiResponse.response;
                        } else {
                            // Fall back to local AI if Gemini fails
                            console.warn('Gemini failed, falling back to local AI:', geminiResponse.error);
                            return this.generateLocalAiResponse(message);
                        }
                    } else {
                        // Use local AI if Gemini is not configured
                        return this.generateLocalAiResponse(message);
                    }
                } catch (error) {
                    console.error('Error getting AI response:', error);
                    return this.generateLocalAiResponse(message);
                }
            },

            async generateLocalAiResponse(message) {
                // Fallback to the original local AI implementation
                const query = message.toLowerCase();
                const searchResults = await this.searchContentForAi(query);
                return this.generateAiResponse(query, searchResults);
            },

            async searchContentForAi(query) {
                const results = [];
                const queryWords = query.split(/\s+/).filter(word => word.length > 2);
                
                // Search through sections for relevant content
                for (const section of guideData.sections.slice(0, 20)) { // Limit for performance
                    try {
                        if (section.mdFile) {
                            const response = await fetch(section.mdFile);
                            if (response.ok) {
                                const content = await response.text();
                                const contentLower = content.toLowerCase();
                                
                                // Check if any query words match
                                const matches = queryWords.filter(word => 
                                    contentLower.includes(word) || 
                                    section.title.toLowerCase().includes(word)
                                );
                                
                                if (matches.length > 0) {
                                    results.push({
                                        section,
                                        content,
                                        relevance: matches.length,
                                        matches
                                    });
                                }
                            }
                        }
                    } catch (error) {
                        console.warn(`Failed to search content for AI: ${section.id}`, error);
                    }
                }
                
                return results.sort((a, b) => b.relevance - a.relevance).slice(0, 3);
            },

            generateAiResponse(query, searchResults) {
                const queryLower = query.toLowerCase();
                
                // Predefined responses for common questions
                const commonResponses = {
                    'what is snomed ct': 'SNOMED CT (Systematized Nomenclature of Medicine -- Clinical Terms) is a comprehensive clinical terminology that provides a common language for electronic health applications. It enables consistent representation of clinical content in electronic health records.',
                    'concept model': 'The SNOMED CT concept model defines the structure and relationships between concepts. It includes defining characteristics, qualifying characteristics, and attributes that specify how concepts are modeled and related to each other.',
                    'naming convention': 'SNOMED CT naming conventions ensure consistency in concept names. They include rules for capitalization, abbreviations, and terminology to maintain clarity and standardization across the terminology.',
                    'authoring': 'Authoring in SNOMED CT involves creating new concepts following established guidelines. This includes proper modeling, naming conventions, and ensuring concepts are fully defined with appropriate relationships.',
                    'body structure': 'Body structure concepts represent anatomical entities. They are modeled with specific attributes like laterality, body structure, and morphological abnormality, following anatomical modeling guidelines.',
                    'clinical finding': 'Clinical findings represent observations, assessments, and diagnoses. They are modeled with attributes like finding site, associated morphology, and clinical course to accurately represent clinical information.',
                    'procedure': 'Procedures represent clinical interventions and actions. They include attributes like procedure site, method, and access site to specify how and where procedures are performed.'
                };
                
                // Check for exact matches first
                for (const [key, response] of Object.entries(commonResponses)) {
                    if (queryLower.includes(key)) {
                        return response;
                    }
                }
                
                // Generate response based on search results
                if (searchResults.length > 0) {
                    const topResult = searchResults[0];
                    const section = topResult.section;
                    
                    return `Based on the SNOMED CT Editorial Guide, I found relevant information about "${section.title}". ${this.extractRelevantContent(topResult.content, query)} You can find more detailed information in the "${section.title}" section of the guide.`;
                }
                
                // Default response
                return `I understand you're asking about "${query}". While I don't have specific information about that topic in my current knowledge base, I can help you search through the SNOMED CT Editorial Guide for relevant content. Try asking about concept modeling, naming conventions, authoring guidelines, or specific domains like body structure, clinical findings, or procedures.`;
            },

            extractRelevantContent(content, query) {
                const queryWords = query.toLowerCase().split(/\s+/).filter(word => word.length > 2);
                const sentences = content.split(/[.!?]+/);
                
                for (const sentence of sentences) {
                    const sentenceLower = sentence.toLowerCase();
                    const matches = queryWords.filter(word => sentenceLower.includes(word));
                    if (matches.length >= 2) {
                        return sentence.trim() + '. ';
                    }
                }
                
                return 'This section contains relevant information about your query. ';
            },

            formatAiResponse(response) {
                // Enhanced markdown formatting for Gemini responses
                let formatted = response;
                
                // Headers
                formatted = formatted.replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">$1</h3>');
                formatted = formatted.replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold text-gray-800 mt-6 mb-3">$1</h2>');
                formatted = formatted.replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold text-gray-800 mt-6 mb-4">$1</h1>');
                
                // Bold and italic
                formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-gray-900">$1</strong>');
                formatted = formatted.replace(/\*(.*?)\*/g, '<em class="italic text-gray-700">$1</em>');
                
                // Code blocks (multi-line)
                formatted = formatted.replace(/```([\s\S]*?)```/g, '<pre class="bg-gray-100 border border-gray-200 rounded-lg p-4 my-3 overflow-x-auto"><code class="text-sm font-mono text-gray-800">$1</code></pre>');
                
                // Inline code
                formatted = formatted.replace(/`([^`]+)`/g, '<code class="bg-gray-200 px-2 py-1 rounded text-sm font-mono text-gray-800">$1</code>');
                
                // Lists
                formatted = formatted.replace(/^\* (.*$)/gim, '<li class="ml-4 mb-1">‚Ä¢ $1</li>');
                formatted = formatted.replace(/^- (.*$)/gim, '<li class="ml-4 mb-1">‚Ä¢ $1</li>');
                formatted = formatted.replace(/^\d+\. (.*$)/gim, '<li class="ml-4 mb-1">$&</li>');
                
                // Wrap consecutive list items in ul/ol tags
                formatted = formatted.replace(/(<li[^>]*>.*?<\/li>)/gs, '<ul class="list-disc ml-4 my-3 space-y-1">$1</ul>');
                
                // Paragraphs (ensure proper spacing)
                formatted = formatted.replace(/\n\n/g, '</p><p class="mb-3 leading-relaxed">');
                formatted = formatted.replace(/^([^<].*)/gm, '<p class="mb-3 leading-relaxed">$1');
                
                // SNOMED CT concept IDs
                formatted = formatted.replace(/(\d{6,18})\s*\|([^|]+)\|/g, '<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-mono" title="SNOMED CT Concept: $2">$1</span> |$2|');
                
                // Links
                formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-blue-600 hover:text-blue-800 underline">$1</a>');
                
                // Blockquotes
                formatted = formatted.replace(/^> (.*$)/gim, '<blockquote class="border-l-4 border-blue-500 pl-4 my-3 italic text-gray-700">$1</blockquote>');
                
                // Horizontal rules
                formatted = formatted.replace(/^---$/gm, '<hr class="my-4 border-gray-300">');
                
                // Tables (basic support)
                formatted = formatted.replace(/\|(.+)\|/g, function(match) {
                    const cells = match.split('|').slice(1, -1);
                    const cellHtml = cells.map(cell => `<td class="px-3 py-2 border border-gray-300">${cell.trim()}</td>`).join('');
                    return `<tr>${cellHtml}</tr>`;
                });
                
                // Clean up any double-wrapped paragraphs
                formatted = formatted.replace(/<p[^>]*><p[^>]*>/g, '<p class="mb-3 leading-relaxed">');
                formatted = formatted.replace(/<\/p><\/p>/g, '</p>');
                
                // Ensure the response is properly wrapped
                if (!formatted.startsWith('<')) {
                    formatted = '<p class="mb-3 leading-relaxed">' + formatted + '</p>';
                }
                
                return formatted;
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            // AI Settings Functions
            openAiSettings() {
                // Load current settings
                const apiKey = localStorage.getItem('geminiApiKey') || '';
                document.getElementById('geminiApiKey').value = apiKey;
                
                // Update status display
                this.updateAiStatus();
                this.updateCacheInfo();
                
                // Show settings modal
                document.getElementById('aiSettingsModal').classList.remove('hidden');
            },

            closeAiSettings() {
                document.getElementById('aiSettingsModal').classList.add('hidden');
            },

            async saveAiSettings() {
                const apiKey = document.getElementById('geminiApiKey').value.trim();
                
                // Save to localStorage
                localStorage.setItem('geminiApiKey', apiKey);
                
                // Update Gemini service
                if (geminiService) {
                    geminiService.apiKey = apiKey;
                    geminiService.isAvailable = !!apiKey;
                }
                
                // Update config
                if (config) {
                    config.gemini.apiKey = apiKey;
                }
                
                // Update status
                this.updateAiStatus();
                
                // Close settings
                this.closeAiSettings();
                
                // Show success message
                this.showNotification('AI settings saved successfully!', 'success');
            },

            toggleApiKeyVisibility() {
                const input = document.getElementById('geminiApiKey');
                const button = document.getElementById('toggleApiKeyVisibility');
                const icon = button.querySelector('.material-icons');
                
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.textContent = 'visibility_off';
                } else {
                    input.type = 'password';
                    icon.textContent = 'visibility';
                }
            },

            clearAiCache() {
                if (geminiService) {
                    geminiService.clearCache();
                    this.updateCacheInfo();
                    this.showNotification('AI response cache cleared!', 'success');
                }
            },

            updateAiStatus() {
                const statusIndicator = document.getElementById('aiStatusIndicator');
                const statusText = document.getElementById('aiStatusText');
                const apiStatusIndicator = document.getElementById('apiStatusIndicator');
                const apiStatusText = document.getElementById('apiStatusText');
                
                const isConfigured = geminiService && geminiService.isConfigured();
                
                if (isConfigured) {
                    statusIndicator.className = 'w-2 h-2 rounded-full mr-2 bg-green-500';
                    statusText.textContent = 'Gemini AI Ready';
                    apiStatusIndicator.className = 'w-3 h-3 rounded-full bg-green-500';
                    apiStatusText.textContent = 'Configured and ready';
                } else {
                    statusIndicator.className = 'w-2 h-2 rounded-full mr-2 bg-yellow-500';
                    statusText.textContent = 'Local AI Mode';
                    apiStatusIndicator.className = 'w-3 h-3 rounded-full bg-yellow-500';
                    apiStatusText.textContent = 'Not configured - using local AI';
                }
            },

            updateCacheInfo() {
                if (geminiService) {
                    const stats = geminiService.getCacheStats();
                    document.getElementById('cacheInfo').textContent = `${stats.size} cached responses`;
                }
            },

            showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full`;
                
                const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
                notification.className += ` ${bgColor} text-white`;
                
                notification.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="material-icons text-sm">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}</span>
                        <span class="text-sm">${message}</span>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.classList.remove('translate-x-full');
                }, 100);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            },

            showSearchSuggestions(query) {
                const suggestions = this.getSearchSuggestions(query);
                const suggestionsContainer = document.getElementById('searchSuggestions');
                
                if (suggestions.length === 0) {
                    this.hideSearchSuggestions();
                    return;
                }
                
                const suggestionsHTML = suggestions.map(suggestion => `
                    <div class="px-4 py-2 hover:bg-gray-50 cursor-pointer suggestion-item" 
                         onclick="app.selectSearchSuggestion('${suggestion.id}')">
                        <div class="flex items-center space-x-3">
                            <span class="material-icons text-gray-400 text-sm">${suggestion.icon}</span>
                            <div>
                                <div class="text-sm font-medium text-gray-800">${suggestion.title}</div>
                                ${suggestion.category ? `<div class="text-xs text-gray-500">${suggestion.category}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
                
                suggestionsContainer.innerHTML = suggestionsHTML;
                suggestionsContainer.classList.remove('hidden');
            },

            hideSearchSuggestions() {
                document.getElementById('searchSuggestions').classList.add('hidden');
            },

            getSearchSuggestions(query) {
                const queryLower = query.toLowerCase();
                const suggestions = [];
                
                // Search through sections for suggestions
                guideData.sections.forEach(section => {
                    const titleMatch = section.title.toLowerCase().includes(queryLower);
                    const categoryMatch = section.category && section.category.toLowerCase().includes(queryLower);
                    
                    if (titleMatch || categoryMatch) {
                        suggestions.push({
                            id: section.id,
                            title: section.title,
                            category: section.category,
                            icon: this.getSectionIcon(section.id, section.title)
                        });
                    }
                });
                
                return suggestions.slice(0, 8); // Limit to 8 suggestions
            },

            selectSearchSuggestion(sectionId) {
                document.getElementById('searchInput').value = '';
                this.hideSearchSuggestions();
                this.selectSection(sectionId);
            },

            setupEventListeners() {
                // Search functionality with debouncing and suggestions
                let searchTimeout;
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    const query = e.target.value.trim();
                    
                    // Show suggestions for short queries
                    if (query.length > 0 && query.length < 3) {
                        this.showSearchSuggestions(query);
                    } else {
                        this.hideSearchSuggestions();
                    }
                    
                    searchTimeout = setTimeout(() => {
                        this.search(query);
                    }, 300); // Debounce search for 300ms
                });

                // Hide suggestions when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#searchInput') && !e.target.closest('#searchSuggestions')) {
                        this.hideSearchSuggestions();
                    }
                });

                // AI Chat functionality
                document.getElementById('aiChatButton').addEventListener('click', () => {
                    this.openAiChat();
                });

                document.getElementById('closeAiChat').addEventListener('click', () => {
                    this.closeAiChat();
                });

                document.getElementById('sendMessage').addEventListener('click', () => {
                    this.sendAiMessage();
                });

                document.getElementById('chatInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendAiMessage();
                    }
                });

                // AI Settings functionality
                document.getElementById('aiSettingsButton').addEventListener('click', () => {
                    this.openAiSettings();
                });

                document.getElementById('closeAiSettings').addEventListener('click', () => {
                    this.closeAiSettings();
                });

                document.getElementById('cancelAiSettings').addEventListener('click', () => {
                    this.closeAiSettings();
                });

                document.getElementById('saveAiSettings').addEventListener('click', () => {
                    this.saveAiSettings();
                });

                document.getElementById('toggleApiKeyVisibility').addEventListener('click', () => {
                    this.toggleApiKeyVisibility();
                });

                document.getElementById('clearCache').addEventListener('click', () => {
                    this.clearAiCache();
                });

                // Section selection
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.section-item')) {
                        const sectionId = e.target.closest('.section-item').dataset.section;
                        this.selectSection(sectionId);
                    }
                });

                // Scroll progress tracking
                window.addEventListener('scroll', () => {
                    this.updateProgressBar();
                    this.updateScrollToTopButton();
                });

                // Concept link clicks
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('concept-link')) {
                        const conceptId = e.target.dataset.conceptId;
                        if (conceptId && conceptMap[conceptId]) {
                            this.selectSection(conceptMap[conceptId]);
                        }
                    }
                });

                // Cross-reference clicks
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('cross-ref-link')) {
                        const sectionId = e.target.dataset.section;
                        this.selectSection(sectionId);
                    }
                });
            },



            setupProgressBar() {
                this.updateProgressBar();
            },

            updateProgressBar() {
                const scrollTop = window.pageYOffset;
                const docHeight = document.documentElement.scrollHeight - window.innerHeight;
                const scrollPercent = (scrollTop / docHeight) * 100;
                document.getElementById('progressBar').style.width = `${Math.min(scrollPercent, 100)}%`;
            },

            updateScrollToTopButton() {
                const scrollToTopBtn = document.getElementById('scrollToTop');
                if (window.pageYOffset > 300) {
                    scrollToTopBtn.classList.remove('opacity-0', 'pointer-events-none');
                    scrollToTopBtn.classList.add('opacity-100');
                } else {
                    scrollToTopBtn.classList.add('opacity-0', 'pointer-events-none');
                    scrollToTopBtn.classList.remove('opacity-100');
                }
            },



            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 'k':
                                e.preventDefault();
                                document.getElementById('searchInput').focus();
                                break;
                            case 'ArrowLeft':
                                e.preventDefault();
                                this.navigateToPrevious();
                                break;
                            case 'ArrowRight':
                                e.preventDefault();
                                this.navigateToNext();
                                break;
                        }
                    }
                    
                    // AI Chat shortcut: Ctrl/Cmd + /
                    if ((e.ctrlKey || e.metaKey) && e.key === '/') {
                        e.preventDefault();
                        this.openAiChat();
                    }
                    
                    // Escape to close AI chat
                    if (e.key === 'Escape') {
                        const modal = document.getElementById('aiChatModal');
                        if (!modal.classList.contains('hidden')) {
                            this.closeAiChat();
                        }
                    }
                });
            },
            
            setupSidebarScrollBehavior() {
                const sidebar = document.querySelector('.sidebar-container');
                const footer = document.querySelector('footer');
                
                if (!sidebar || !footer) return;
                
                const handleScroll = () => {
                    const scrollTop = window.pageYOffset;
                    const windowHeight = window.innerHeight;
                    const documentHeight = document.documentElement.scrollHeight;
                    const footerTop = footer.offsetTop;
                    const sidebarHeight = sidebar.offsetHeight;
                    const headerHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-height'));
                    
                    // Calculate when sidebar should become unsticky
                    const threshold = footerTop - windowHeight + headerHeight;
                    
                    if (scrollTop >= threshold) {
                        // Make sidebar unsticky to prevent footer overlap
                        sidebar.classList.remove('sticky');
                        sidebar.classList.add('unsticky');
                    } else {
                        // Keep sidebar sticky
                        sidebar.classList.remove('unsticky');
                        sidebar.classList.add('sticky');
                    }
                };
                
                // Add scroll event listener
                window.addEventListener('scroll', handleScroll);
                
                // Initial call to set correct state
                handleScroll();
            },

            navigateToPrevious() {
                const sections = guideData.sections;
                const currentIndex = sections.findIndex(s => s.id === guideData.currentSection);
                if (currentIndex > 0) {
                    const prevSection = sections[currentIndex - 1];
                    console.log(`‚¨ÖÔ∏è Navigating to previous: ${prevSection.title} (${prevSection.id})`);
                    this.selectSection(prevSection.id);
                }
            },

            navigateToNext() {
                const sections = guideData.sections;
                const currentIndex = sections.findIndex(s => s.id === guideData.currentSection);
                if (currentIndex < sections.length - 1) {
                    const nextSection = sections[currentIndex + 1];
                    console.log(`‚û°Ô∏è Navigating to next: ${nextSection.title} (${nextSection.id})`);
                    this.selectSection(nextSection.id);
                }
            },



            toggleSection(sectionId) {
                const content = document.getElementById(`${sectionId}-content`);
                const icon = document.getElementById(`${sectionId}-icon`);
                
                if (this.currentCollapsedSections.has(sectionId)) {
                    content.classList.remove('collapsed');
                    icon.classList.remove('rotated');
                    this.currentCollapsedSections.delete(sectionId);
                } else {
                    content.classList.add('collapsed');
                    icon.classList.add('rotated');
                    this.currentCollapsedSections.add(sectionId);
                }
            },

            linkifyText(text) {
                // Ensure text is a string
                if (typeof text !== 'string') {
                    return text || '';
                }
                
                // Convert concept references to clickable links
                return text.replace(/(\d{5,})/g, (match) => {
                    if (conceptMap[match]) {
                        return `<span class="concept-link" data-concept-id="${match}">${match}</span>`;
                    }
                    return match;
                }).replace(/(Body structure|Clinical finding|Procedure|Pharmaceutical|Observable entity|Organism|Substance|Specimen)/gi, (match) => {
                    const sectionMap = {
                        'Body structure': 'body-structure',
                        'Clinical finding': 'clinical-finding',
                        'Procedure': 'procedure',
                        'Pharmaceutical': 'pharmaceutical',
                        'Observable entity': 'observable-entity',
                        'Organism': 'organism',
                        'Substance': 'substance',
                        'Specimen': 'specimen'
                    };
                    const sectionId = sectionMap[match];
                    if (sectionId) {
                        return `<span class="cross-ref-link" data-section="${sectionId}">${match}</span>`;
                    }
                    return match;
                });
            },

            linkifyExpression(expression) {
                // Convert SNOMED CT expressions to clickable concept links
                return expression.replace(/(\d{5,})\|([^|]+)\|/g, (match, id, name) => {
                    if (conceptMap[id]) {
                        return `<span class="concept-link" data-concept-id="${id}">${id}|${name}|</span>`;
                    }
                    return match;
                });
            },

            createHierarchyLinks(hierarchy) {
                return hierarchy.split(' > ').map(part => {
                    const trimmed = part.trim();
                    const sectionMap = {
                        'Body structure': 'body-structure',
                        'Clinical finding': 'clinical-finding',
                        'Procedure': 'procedure',
                        'Disease': 'clinical-finding',
                        'Anatomical structure': 'body-structure'
                    };
                    const sectionId = sectionMap[trimmed];
                    if (sectionId) {
                        return `<span class="cross-ref-link" data-section="${sectionId}">${trimmed}</span>`;
                    }
                    return trimmed;
                }).join('<span class="hierarchy-arrow">‚ñ∂</span>');
            },

            showConceptDetails(conceptId) {
                // Show concept details in a modal or expand section
                const section = conceptMap[conceptId];
                if (section) {
                    this.selectSection(section);
                    // Scroll to highlight the concept
                    setTimeout(() => {
                        const elements = document.querySelectorAll(`[data-concept-id="${conceptId}"]`);
                        if (elements.length > 0) {
                            elements[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                            elements[0].style.background = '#fef3c7';
                            setTimeout(() => {
                                elements[0].style.background = '';
                            }, 2000);
                        }
                    }, 500);
                }
            },

            addCrossReferences(sectionId) {
                const refs = crossReferences[sectionId];
                if (!refs || refs.length === 0) return '';
                
                return `
                    <div class="cross-ref">
                        <h4 class="font-semibold text-blue-800 mb-2">
                            <span class="material-icons text-sm mr-1">link</span>
                            Related Sections:
                        </h4>
                        <div class="flex flex-wrap gap-2">
                            ${refs.map(refId => {
                                const refSection = guideData.sections.find(s => s.id === refId);
                                return refSection ? `
                                    <span class="cross-ref-link" data-section="${refId}">
                                        ${refSection.title}
                                    </span>
                                ` : '';
                            }).join('')}
                        </div>
                    </div>
                `;
            },

            renderStatistics() {
                return `
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                            <span class="material-icons mr-2">analytics</span>
                            SNOMED CT Release Statistics (July 2025)
                        </h3>
                        
                        <!-- Summary Stats Cards -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                            <div class="stats-card">
                                <div class="stat-number">${snomedStats.totalActive.toLocaleString()}</div>
                                <div class="stat-label">Active Concepts</div>
                                <div class="stat-change positive mt-2">+${snomedStats.summary.totalNew}</div>
                            </div>
                            <div class="stats-card">
                                <div class="stat-number">${snomedStats.totalConcepts.toLocaleString()}</div>
                                <div class="stat-label">Total Concepts</div>
                                <div class="stat-change neutral mt-2">All Time</div>
                            </div>
                            <div class="stats-card">
                                <div class="stat-number">${snomedStats.summary.totalNew}</div>
                                <div class="stat-label">New This Release</div>
                                <div class="stat-change positive mt-2">+${snomedStats.summary.totalNew}</div>
                            </div>
                            <div class="stats-card">
                                <div class="stat-number">${snomedStats.summary.totalChanged}</div>
                                <div class="stat-label">Modified</div>
                                <div class="stat-change neutral mt-2">Updated</div>
                            </div>
                        </div>

                        <!-- Hierarchy Distribution Chart -->
                        <div class="chart-container">
                            <div class="chart-title">
                                <span class="material-icons">bar_chart</span>
                                Concept Distribution by Hierarchy
                            </div>
                            <div class="stats-filters">
                                <button class="filter-btn active" onclick="app.filterChart('active')">Active Concepts</button>
                                <button class="filter-btn" onclick="app.filterChart('total')">Total Concepts</button>
                                <button class="filter-btn" onclick="app.filterChart('new')">New Concepts</button>
                            </div>
                            <div class="bar-chart" id="hierarchyChart">
                                ${this.renderHierarchyChart('active')}
                            </div>
                        </div>

                        <!-- Top Hierarchies by Activity -->
                        <div class="chart-container">
                            <div class="chart-title">
                                <span class="material-icons">trending_up</span>
                                Most Active Hierarchies
                            </div>
                            <div class="progress-container">
                                ${this.renderTopHierarchies()}
                            </div>
                        </div>

                        <!-- Release Activity Summary -->
                        <div class="chart-container">
                            <div class="chart-title">
                                <span class="material-icons">pie_chart</span>
                                Release Activity Breakdown
                            </div>
                            <div class="grid md:grid-cols-2 gap-8">
                                <div>
                                    <div class="pie-chart" id="activityPieChart">
                                        ${this.renderActivityPieChart()}
                                    </div>
                                    <div class="pie-legend">
                                        <div class="legend-item">
                                            <div class="legend-color" style="background: #10b981;"></div>
                                            <span>New Concepts (${snomedStats.summary.totalNew})</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background: #3b82f6;"></div>
                                            <span>Modified (${snomedStats.summary.totalChanged})</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background: #ef4444;"></div>
                                            <span>Inactivated (${snomedStats.summary.totalInactivated})</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div class="p-4 bg-blue-50 rounded-lg">
                                        <h4 class="font-semibold text-blue-800 mb-2">Release Highlights</h4>
                                        <ul class="text-sm text-blue-700 space-y-1">
                                            <li>‚Ä¢ ${snomedStats.summary.totalNew} new concepts added</li>
                                            <li>‚Ä¢ ${snomedStats.summary.totalChanged} concepts modified</li>
                                            <li>‚Ä¢ ${snomedStats.summary.totalInactivated} concepts inactivated</li>
                                            <li>‚Ä¢ ${snomedStats.summary.totalReactivated} concepts reactivated</li>
                                        </ul>
                                    </div>
                                    <div class="p-4 bg-green-50 rounded-lg">
                                        <h4 class="font-semibold text-green-800 mb-2">Growth Metrics</h4>
                                        <ul class="text-sm text-green-700 space-y-1">
                                            <li>‚Ä¢ ${((snomedStats.summary.totalNew / snomedStats.totalActive) * 100).toFixed(2)}% growth rate</li>
                                            <li>‚Ä¢ ${snomedStats.summary.newSD} new fully defined concepts</li>
                                            <li>‚Ä¢ ${snomedStats.summary.newP} new primitive concepts</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderHierarchyChart(filterType = 'active') {
                const sortedHierarchies = [...snomedStats.hierarchies].sort((a, b) => b[filterType] - a[filterType]);
                const maxValue = Math.max(...sortedHierarchies.map(h => h[filterType]));
                
                return sortedHierarchies.slice(0, 10).map(hierarchy => {
                    const percentage = (hierarchy[filterType] / maxValue) * 100;
                    const height = Math.max(percentage, 5); // Minimum 5% height for visibility
                    
                    return `
                        <div class="bar" style="height: ${height}%;" 
                             onclick="app.showHierarchyDetails('${hierarchy.id}')"
                             title="${hierarchy.name}: ${hierarchy[filterType].toLocaleString()}">
                            <div class="bar-value">${hierarchy[filterType].toLocaleString()}</div>
                            <div class="bar-label">${hierarchy.name.split(' ')[0]}</div>
                        </div>
                    `;
                }).join('');
            },

            renderTopHierarchies() {
                const sortedHierarchies = [...snomedStats.hierarchies]
                    .sort((a, b) => b.active - a.active)
                    .slice(0, 8);
                
                return sortedHierarchies.map(hierarchy => {
                    const percentage = (hierarchy.active / snomedStats.totalActive) * 100;
                    
                    return `
                        <div class="progress-item">
                            <div class="progress-label">${hierarchy.name}</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: ${percentage}%"></div>
                            </div>
                            <div class="progress-value">${hierarchy.active.toLocaleString()}</div>
                        </div>
                    `;
                }).join('');
            },

            renderActivityPieChart() {
                const total = snomedStats.summary.totalNew + snomedStats.summary.totalChanged + snomedStats.summary.totalInactivated;
                const newAngle = (snomedStats.summary.totalNew / total) * 360;
                const changedAngle = (snomedStats.summary.totalChanged / total) * 360;
                
                return `
                    <div class="pie-segment" style="background: conic-gradient(#10b981 0deg ${newAngle}deg, #3b82f6 ${newAngle}deg ${newAngle + changedAngle}deg, #ef4444 ${newAngle + changedAngle}deg 360deg);"></div>
                `;
            },

            filterChart(filterType) {
                // Update filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                
                // Update chart
                document.getElementById('hierarchyChart').innerHTML = this.renderHierarchyChart(filterType);
            },

            showHierarchyDetails(hierarchyId) {
                const hierarchy = snomedStats.hierarchies.find(h => h.id === hierarchyId);
                if (!hierarchy) return;
                
                // Find corresponding section
                const sectionMap = {
                    '123037004': 'body-structure',
                    '404684003': 'clinical-finding',
                    '71388002': 'procedure',
                    '373873005': 'pharmaceutical',
                    '410607006': 'organism',
                    '105590001': 'substance',
                    '363787002': 'observable-entity',
                    '123038009': 'specimen'
                };
                
                const sectionId = sectionMap[hierarchyId];
                if (sectionId) {
                    this.selectSection(sectionId);
                }
                
                // Show details in a tooltip or modal
                alert(`${hierarchy.name}\n\nActive: ${hierarchy.active.toLocaleString()}\nTotal: ${hierarchy.total.toLocaleString()}\nNew: ${hierarchy.new}\nChanged: ${hierarchy.changed}\nInactivated: ${hierarchy.inactivated}`);
            },

            renderEnhancedContent(section) {
                let enhancedContent = '';
                
                // Special rendering for Clinical Finding section
                if (section.id === 'clinical-finding') {
                    enhancedContent += this.renderClinicalFindingContent(section.content);
                } else {
                    // Render detailed subsections based on section type
                    if (section.content.whatIsSNOMEDCTDetails) {
                        enhancedContent += this.renderDetailedSubsection('What is SNOMED CT?', section.content.whatIsSNOMEDCTDetails);
                    }
                    
                    if (section.content.whyUseSNOMEDCTDetails) {
                        enhancedContent += this.renderDetailedSubsection('Why Use SNOMED CT?', section.content.whyUseSNOMEDCTDetails);
                    }
                    
                    if (section.content.intendedUseDetails) {
                        enhancedContent += this.renderDetailedSubsection('Intended Use Details', section.content.intendedUseDetails);
                    }
                    
                    if (section.content.semanticInteroperabilityDetails) {
                        enhancedContent += this.renderDetailedSubsection('Semantic Interoperability', section.content.semanticInteroperabilityDetails);
                    }
                    
                    if (section.content.overviewDetails) {
                        enhancedContent += this.renderDetailedSubsection('Concept Model Details', section.content.overviewDetails);
                    }
                    
                    if (section.content.topLevelConceptsDetails) {
                        enhancedContent += this.renderDetailedSubsection('Top-Level Concepts', section.content.topLevelConceptsDetails);
                    }
                }
                
                return enhancedContent;
            },

            renderDetailedSubsection(title, content) {
                return `
                    <div class="collapsible-section mb-6">
                        <div class="collapsible-header" onclick="app.toggleSection('${title.replace(/\s+/g, '-').toLowerCase()}')">
                            <h4 class="text-lg font-semibold text-gray-800">${title}</h4>
                            <span class="material-icons expand-icon" id="${title.replace(/\s+/g, '-').toLowerCase()}-icon">expand_more</span>
                        </div>
                        <div class="collapsible-content" id="${title.replace(/\s+/g, '-').toLowerCase()}-content">
                            ${this.renderContentByType(content)}
                        </div>
                    </div>
                `;
            },

            renderContentByType(content) {
                if (typeof content === 'string') {
                    return `<p class="text-gray-700">${this.linkifyText(content)}</p>`;
                }
                
                if (Array.isArray(content)) {
                    return `
                        <ul class="list-disc list-inside space-y-2 text-gray-700">
                            ${content.map(item => `<li>${typeof item === 'string' ? this.linkifyText(item) : JSON.stringify(item)}</li>`).join('')}
                        </ul>
                    `;
                }
                
                if (typeof content === 'object') {
                    let html = '';
                    
                    for (const [key, value] of Object.entries(content)) {
                        const formattedKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                        
                        if (Array.isArray(value)) {
                            html += `
                                <div class="mb-4">
                                    <h5 class="font-medium text-gray-800 mb-2">${formattedKey}:</h5>
                                    <ul class="list-disc list-inside space-y-1 text-gray-700 ml-4">
                                        ${value.map(item => `<li>${typeof item === 'string' ? this.linkifyText(item) : JSON.stringify(item)}</li>`).join('')}
                                    </ul>
                                </div>
                            `;
                        } else if (typeof value === 'object') {
                            html += `
                                <div class="mb-4">
                                    <h5 class="font-medium text-gray-800 mb-2">${formattedKey}:</h5>
                                    <div class="ml-4">
                                        ${this.renderContentByType(value)}
                                    </div>
                                </div>
                            `;
                        } else {
                            html += `
                                <div class="mb-4">
                                    <h5 class="font-medium text-gray-800 mb-2">${formattedKey}:</h5>
                                    <p class="text-gray-700 ml-4">${typeof value === 'string' ? this.linkifyText(value) : value}</p>
                                </div>
                            `;
                        }
                    }
                    
                    return html;
                }
                
                return '';
            },

            renderClinicalFindingContent(content) {
                return `
                    <!-- Definition Table -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Definition</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full border border-gray-300 bg-white">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-4 py-2 text-left font-semibold text-gray-800">Definition</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left font-semibold text-gray-800">Examples</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="border border-gray-300 px-4 py-2 text-gray-700">
                                            <strong>Clinical finding:</strong> ${content.definition.clinicalFinding}
                                        </td>
                                        <td class="border border-gray-300 px-4 py-2 text-gray-700">
                                            <div class="mb-2">
                                                <strong>${content.definition.examples[0].type}:</strong><br>
                                                <span class="concept-id" onclick="app.showConceptDetails('${content.definition.examples[0].id}')">${content.definition.examples[0].id}</span> | ${content.definition.examples[0].concept} |
                                            </div>
                                            <div>
                                                <strong>${content.definition.examples[1].type}:</strong><br>
                                                <span class="concept-id" onclick="app.showConceptDetails('${content.definition.examples[1].id}')">${content.definition.examples[1].id}</span> | ${content.definition.examples[1].concept} |
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Observations -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Observations</h3>
                        <p class="text-gray-700 mb-4">${content.observations}</p>
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                            <p class="text-gray-700"><strong>Note:</strong> ${content.observableEntityNote}</p>
                        </div>
                    </div>

                    <!-- Context -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Context</h3>
                        <p class="text-gray-700 mb-2">${content.context.default}</p>
                        <ul class="list-disc list-inside space-y-1 text-gray-700 ml-4">
                            ${content.context.elements.map(element => `<li>${element}</li>`).join('')}
                        </ul>
                    </div>

                    <!-- Hierarchy Structure -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Hierarchy Structure</h3>
                        <p class="text-gray-700 mb-4">${content.hierarchyStructure.description}</p>
                        <p class="text-gray-700 mb-4"><strong>Rule:</strong> ${content.hierarchyStructure.rule}</p>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-gray-700"><strong>Example:</strong></p>
                            <p class="text-gray-700">
                                <span class="concept-id" onclick="app.showConceptDetails('${content.hierarchyStructure.example.id}')">${content.hierarchyStructure.example.id}</span> | ${content.hierarchyStructure.example.concept} | has the parent, ${content.hierarchyStructure.example.parent}; it is also a subtype of <span class="concept-id" onclick="app.showConceptDetails('${content.hierarchyStructure.example.id2}')">${content.hierarchyStructure.example.id2}</span> | ${content.hierarchyStructure.example.subtype} | .
                            </p>
                        </div>
                    </div>

                    <!-- Disorder vs Finding Table -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Disorder vs Finding</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full border border-gray-300 bg-white">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-4 py-2 text-left font-semibold text-gray-800">Characteristics</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="border border-gray-300 px-4 py-2">
                                            <div class="mb-4">
                                                <h4 class="font-semibold text-gray-800 mb-2">Disorder</h4>
                                                <ul class="list-disc list-inside space-y-1 text-gray-700 ml-4">
                                                    ${content.disorderVsFinding.disorder.characteristics.map(char => `<li>${char}</li>`).join('')}
                                                </ul>
                                            </div>
                                            <div>
                                                <h4 class="font-semibold text-gray-800 mb-2">Finding</h4>
                                                <ul class="list-disc list-inside space-y-1 text-gray-700 ml-4">
                                                    ${content.disorderVsFinding.finding.characteristics.map(char => `<li>${char}</li>`).join('')}
                                                </ul>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Examples -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Examples</h3>
                        ${content.examples.map(example => `
                            <div class="mb-4">
                                <h4 class="font-semibold text-gray-800 mb-2">${example.scenario}</h4>
                                <p class="text-gray-700 mb-2">${example.description}</p>
                                ${example.details ? `
                                    <ul class="list-disc list-inside space-y-1 text-gray-700 ml-4">
                                        ${example.details.map(detail => `<li>${detail}</li>`).join('')}
                                    </ul>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>

                    <!-- Technical Guidelines -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Technical Guidelines</h3>
                        
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-3">Attributes Summary</h4>
                                <ul class="list-disc list-inside space-y-1 text-gray-700">
                                    ${content.attributesSummary.map(attr => `<li>${attr}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-3">Defining Attributes</h4>
                                <ul class="list-disc list-inside space-y-1 text-gray-700">
                                    ${content.definingAttributes.map(attr => `<li>${attr}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <h4 class="font-semibold text-gray-800 mb-3">Naming Conventions</h4>
                            <ul class="list-disc list-inside space-y-1 text-gray-700">
                                ${content.namingConventions.map(conv => `<li>${conv}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div class="mt-6">
                            <h4 class="font-semibold text-gray-800 mb-3">Modeling Guidelines</h4>
                            <ul class="list-disc list-inside space-y-1 text-gray-700">
                                ${content.modeling.map(guideline => `<li>${guideline}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div class="mt-6">
                            <h4 class="font-semibold text-gray-800 mb-3">Specific Modeling</h4>
                            <ul class="list-disc list-inside space-y-1 text-gray-700">
                                ${content.specificModeling.map(specific => `<li>${specific}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            },

            renderHierarchyStats(sectionId) {
                const hierarchyMap = {
                    'body-structure': '123037004',
                    'clinical-finding': '404684003',
                    'procedure': '71388002',
                    'pharmaceutical': '373873005',
                    'organism': '410607006',
                    'substance': '105590001',
                    'observable-entity': '363787002',
                    'specimen': '123038009'
                };
                
                const hierarchyId = hierarchyMap[sectionId];
                if (!hierarchyId) return '';
                
                const hierarchy = snomedStats.hierarchies.find(h => h.id === hierarchyId);
                if (!hierarchy) return '';
                
                const percentageOfTotal = ((hierarchy.active / snomedStats.totalActive) * 100).toFixed(1);
                const growthRate = hierarchy.new > 0 ? `+${hierarchy.new}` : '0';
                
                return `
                    <div class="mb-8">
                        <div class="chart-container">
                            <div class="chart-title">
                                <span class="material-icons">insights</span>
                                ${hierarchy.name} Hierarchy Statistics
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="stats-card">
                                    <div class="stat-number">${hierarchy.active.toLocaleString()}</div>
                                    <div class="stat-label">Active Concepts</div>
                                    <div class="stat-change positive mt-2">${percentageOfTotal}% of total</div>
                                </div>
                                <div class="stats-card">
                                    <div class="stat-number">${hierarchy.total.toLocaleString()}</div>
                                    <div class="stat-label">Total Concepts</div>
                                    <div class="stat-change neutral mt-2">All time</div>
                                </div>
                                <div class="stats-card">
                                    <div class="stat-number">${hierarchy.new}</div>
                                    <div class="stat-label">New This Release</div>
                                    <div class="stat-change positive mt-2">${growthRate}</div>
                                </div>
                                <div class="stats-card">
                                    <div class="stat-number">${hierarchy.changed}</div>
                                    <div class="stat-label">Modified</div>
                                    <div class="stat-change neutral mt-2">Updated</div>
                                </div>
                            </div>
                            
                            <!-- Hierarchy Activity Timeline -->
                            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-3">Recent Activity</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">New concepts added:</span>
                                        <span class="font-semibold text-green-600">${hierarchy.new}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Concepts modified:</span>
                                        <span class="font-semibold text-blue-600">${hierarchy.changed}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Concepts inactivated:</span>
                                        <span class="font-semibold text-red-600">${hierarchy.inactivated}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600">Market share:</span>
                                        <span class="font-semibold text-gray-800">${percentageOfTotal}% of all active concepts</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },
        };

        // SNOMED CT Terminology Server Configuration
        const SNOMED_CONFIG = {
            // Default to SNOMED Browser instance - users can change this
            baseUrl: 'https://browser.ihtsdotools.org/snowstorm/snomed-ct',
            branch: 'MAIN',
            // SNOMED CT Top-level hierarchy concept IDs
            domainIds: {
                'clinical-finding': '404684003',
                'body-structure': '442083009', 
                'procedure': '71388002',
                'pharmaceutical': '373873005',
                'observable-entity': '363787002',
                'organism': '410607006',
                'substance': '105590001',
                'situation-context': '243796009',
                'specimen': '123038009'
            }
        };

        // Note: This implementation uses the MRCM refset endpoint (723561005) to fetch
        // real-time MRCM constraints. The default server (browser.ihtsdotools.org) 
        // should work without CORS issues. If you encounter problems with other servers:
        // 1. Try the SNOMED Browser endpoint (option 1 in configuration)
        // 2. Use a local Snowstorm instance with CORS enabled
        // 3. Configure CORS headers on your terminology server
        // 4. Use a proxy server to handle CORS requests

        // MRCM API Functions
        class MRCMService {
            constructor(config) {
                this.config = config;
            }

            async fetchMRCMRefsetData() {
                try {
                    // Use the MRCM refset endpoint - 723561005 is the MRCM attribute domain international refset
                    const url = `${this.config.baseUrl}/${this.config.branch}/members?referenceSet=723561005&active=true&limit=1000`;
                    const response = await fetch(url, {
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.warn('Failed to fetch MRCM refset data:', error);
                    return null;
                }
            }

            async fetchAttributeRanges() {
                try {
                    // Fetch the MRCM attribute range refset - 723562000 is the MRCM attribute range international refset
                    const url = `${this.config.baseUrl}/${this.config.branch}/members?referenceSet=723562000&active=true&limit=1000`;
                    const response = await fetch(url, {
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.warn('Failed to fetch MRCM attribute range data:', error);
                    return null;
                }
            }

            async getHRCMData(domainId, domainName) {
                console.log(`Fetching HRCM data for ${domainName} domain from terminology server...`);
                
                try {
                    // Fetch MRCM refset data
                    const mrcmData = await this.fetchMRCMRefsetData();
                    
                    if (!mrcmData || !mrcmData.items) {
                        throw new Error('No MRCM refset data received');
                    }

                    // Filter by specified domain ID
                    const domainAttributes = mrcmData.items.filter(item => 
                        item.additionalFields && 
                        item.additionalFields.domainId === domainId
                    );

                    if (domainAttributes.length === 0) {
                        throw new Error(`No MRCM attributes found for ${domainName} domain`);
                    }

                    // Fetch attribute ranges for additional context
                    const rangeData = await this.fetchAttributeRanges();
                    const rangeMap = {};
                    if (rangeData && rangeData.items) {
                        rangeData.items.forEach(rangeItem => {
                            if (rangeItem.additionalFields && rangeItem.additionalFields.domainId === domainId) {
                                rangeMap[rangeItem.referencedComponentId] = rangeItem.additionalFields.rangeConstraint || 'Not specified';
                            }
                        });
                    }

                    // Process and format the attributes
                    const attributes = domainAttributes.map(item => {
                        const attributeId = item.referencedComponentId;
                        const additionalFields = item.additionalFields;
                        const referencedComponent = item.referencedComponent;
                        
                        // Get attribute name from referenced component
                        const attributeName = referencedComponent?.pt?.term || 
                                            referencedComponent?.fsn?.term || 
                                            `Attribute ${attributeId}`;

                        // Format cardinality values
                        const cardinality = additionalFields.attributeCardinality || 'Not specified';
                        const inGroupCardinality = additionalFields.attributeInGroupCardinality || 'Not specified';
                        
                        // Get range constraint
                        const range = rangeMap[attributeId] || 'Not specified';

                        return {
                            name: attributeName,
                            id: attributeId,
                            grouped: additionalFields.grouped || '0',
                            cardinality: cardinality,
                            inGroupCardinality: inGroupCardinality,
                            range: range,
                            effectiveTime: item.effectiveTime,
                            moduleId: item.moduleId
                        };
                    });

                    // Sort attributes by name for consistent display
                    attributes.sort((a, b) => a.name.localeCompare(b.name));

                    return {
                        title: 'Human Readable Concept Model (HRCM)',
                        version: 'Live from MRCM Refsets',
                        description: `Real-time MRCM data from SNOMED CT MRCM refsets (723561005). This represents the current authoritative constraints for the ${domainName} domain.`,
                        domainConstraint: `< ${domainId} |${domainName}|`,
                        sourceUrl: `${this.config.baseUrl}/${this.config.branch}/members?referenceSet=723561005&active=true&limit=1000`,
                        serverInfo: {
                            baseUrl: this.config.baseUrl,
                            branch: this.config.branch,
                            lastFetched: new Date().toISOString(),
                            refsetId: '723561005',
                            attributeCount: attributes.length,
                            domainId: domainId,
                            domainName: domainName
                        },
                        attributes: attributes
                    };
                    
                } catch (error) {
                    console.error(`Failed to fetch live MRCM data for ${domainName}:`, error);
                    return null;
                }
            }
        }

        // Initialize MRCM service
        const mrcmService = new MRCMService(SNOMED_CONFIG);

                // Global function for direct section linking
        window.goToSection = function(sectionId) {
            console.log(`üîó Direct link to section: ${sectionId}`);
            app.selectSectionInfiniteScroll(sectionId);
        };
        
        // Global function to re-render sidebar
        window.reloadSidebar = function() {
            console.log('üîÑ Re-rendering sidebar...');
            app.renderSidebar();
        };
        
        // Global function to debug section loading
        window.debugSections = function() {
            console.log('üîç Debugging sections...');
            console.log('guideData.sections:', guideData.sections);
            console.log('guideData.hierarchicalSections:', guideData.hierarchicalSections);
            console.log('guideData.hierarchy:', guideData.hierarchy);
        };
        
        // Global debug function for troubleshooting
        window.debugInfiniteScroll = function() {
            console.log('üîß Infinite Scroll Debug Information:');
            console.log('=====================================');
            app.debugNavigation();
            app.checkInfiniteScrollHealth();
            app.showHierarchicalOrder();
            console.log('=====================================');
            console.log('Available debug commands:');
            console.log('- app.debugNavigation() - Debug navigation structure');
            console.log('- app.checkInfiniteScrollHealth() - Check infinite scroll health');
            console.log('- app.showHierarchicalOrder() - Show hierarchical section order');
            console.log('- app.forceCleanup() - Force DOM cleanup');
            console.log('- app.syncNavigationHighlighting() - Force sync highlighting');
            console.log('- app.getDOMStats() - Get DOM statistics');
            console.log('- app.testHighlight(sectionId) - Test highlighting for specific section');
            console.log('- app.jumpToSection(sectionId) - Jump to specific section');
            console.log('- app.selectSectionInfiniteScroll(sectionId) - Select specific section with infinite scroll');
        };

        // Global functions for HRCM management
        window.refreshHRCM = async function(placeholderId, sectionId) {
            const placeholder = document.getElementById(placeholderId);
            if (!placeholder) return;
            
            const domainId = SNOMED_CONFIG.domainIds[sectionId];
            const domainName = sectionId === 'clinical-finding' ? 'Clinical finding (finding)' : 
                              guideData.sections.find(s => s.id === sectionId)?.title.replace(' Concepts', '') || 'Unknown';
            
            placeholder.innerHTML = `
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Human Readable Concept Model (HRCM)</h3>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center space-x-2">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                        <p class="text-sm text-blue-700">Refreshing MRCM data from refset 723561005...</p>
                    </div>
                    <p class="text-xs text-blue-600 mt-2">Server: ${SNOMED_CONFIG.baseUrl}/${SNOMED_CONFIG.branch}</p>
                </div>
            `;
            
            try {
                const hrcmData = await mrcmService.getHRCMData(domainId, domainName);
                
                if (hrcmData && hrcmData.attributes) {
                    placeholder.innerHTML = `
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Human Readable Concept Model (HRCM)</h3>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="material-icons text-green-600 text-sm">check_circle</span>
                                <p class="text-sm text-green-800 font-medium">Live Data Retrieved</p>
                            </div>
                            <p class="text-sm text-green-700 mb-2"><strong>Version:</strong> ${hrcmData.version}</p>
                            <p class="text-sm text-green-700 mb-2">${hrcmData.description}</p>
                            <p class="text-sm text-green-700 mb-2"><strong>Domain Constraint:</strong> <code class="bg-green-100 px-1 rounded">${hrcmData.domainConstraint}</code></p>
                            <p class="text-sm text-green-700 mb-2"><strong>Server:</strong> <a href="${hrcmData.sourceUrl}" target="_blank" class="text-green-600 hover:text-green-800 underline">${hrcmData.serverInfo.baseUrl}</a></p>
                            <p class="text-xs text-green-600 mb-1"><strong>MRCM Refset:</strong> ${hrcmData.serverInfo.refsetId} (${hrcmData.serverInfo.attributeCount} attributes)</p>
                            <p class="text-xs text-green-600"><strong>Last Updated:</strong> ${new Date(hrcmData.serverInfo.lastFetched).toLocaleString()}</p>
                            <div class="mt-3 pt-3 border-t border-green-200">
                                <button onclick="window.refreshHRCM('${placeholderId}', '${sectionId}')" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded mr-2">
                                    <span class="material-icons text-xs mr-1">refresh</span>Refresh Data
                                </button>
                                <button onclick="window.configureHRCM()" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded">
                                    <span class="material-icons text-xs mr-1">settings</span>Configure Server
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h4 class="text-lg font-medium text-gray-800 mb-2">${domainName} Domain Attributes</h4>
                            <p class="text-sm text-gray-600">MRCM constraints for domain ${domainId} |${domainName}|</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300 bg-white text-sm">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="border border-gray-300 px-3 py-2 text-left font-semibold">Attribute</th>
                                        <th class="border border-gray-300 px-3 py-2 text-left font-semibold">SNOMED CT ID</th>
                                        <th class="border border-gray-300 px-3 py-2 text-left font-semibold">Grouped</th>
                                        <th class="border border-gray-300 px-3 py-2 text-left font-semibold">Cardinality</th>
                                        <th class="border border-gray-300 px-3 py-2 text-left font-semibold">In Group</th>
                                        <th class="border border-gray-300 px-3 py-2 text-left font-semibold">Range Constraint</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${hrcmData.attributes.map(attr => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="border border-gray-300 px-3 py-2 font-medium">${attr.name}</td>
                                            <td class="border border-gray-300 px-3 py-2 font-mono text-xs text-gray-600">${attr.id}</td>
                                            <td class="border border-gray-300 px-3 py-2 text-center">${attr.grouped}</td>
                                            <td class="border border-gray-300 px-3 py-2 text-center font-mono text-xs">${attr.cardinality}</td>
                                            <td class="border border-gray-300 px-3 py-2 text-center font-mono text-xs">${attr.inGroupCardinality}</td>
                                            <td class="border border-gray-300 px-3 py-2 text-xs">${attr.range}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    throw new Error('No MRCM data received');
                }
            } catch (error) {
                placeholder.innerHTML = `
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Human Readable Concept Model (HRCM)</h3>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="material-icons text-red-600 text-sm">error</span>
                            <p class="text-sm text-red-800 font-medium">Failed to Refresh HRCM Data</p>
                        </div>
                        <p class="text-sm text-red-700 mb-2">Error: ${error.message}</p>
                        <p class="text-xs text-red-600">Server: ${SNOMED_CONFIG.baseUrl}</p>
                        <div class="mt-3 pt-3 border-t border-red-200">
                            <button onclick="window.refreshHRCM('${placeholderId}', '${sectionId}')" class="bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-1 rounded mr-2">
                                <span class="material-icons text-xs mr-1">refresh</span>Try Again
                            </button>
                            <button onclick="window.configureHRCM()" class="bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-1 rounded">
                                <span class="material-icons text-xs mr-1">settings</span>Configure Server
                            </button>
                        </div>
                    </div>
                `;
            }
        };

        window.configureHRCM = function() {
            const currentUrl = SNOMED_CONFIG.baseUrl;
            const currentBranch = SNOMED_CONFIG.branch;
            
            const serverOptions = `
Common SNOMED CT Terminology Servers:

1. SNOMED Browser (SNOMED International):
   https://browser.ihtsdotools.org/snowstorm/snomed-ct


2. Local Snowstorm:
   http://localhost:8080

3. Custom server...

Current: ${currentUrl}
`;
            
            const choice = prompt(
                `${serverOptions}\n\nEnter:\n- Number (1-5) for preset\n- Full URL for custom server\n- Or press Cancel to keep current:`,
                currentUrl
            );
            
            let newUrl = currentUrl;
            
            if (choice) {
                switch (choice.trim()) {
                    case '1':
                        newUrl = 'https://browser.ihtsdotools.org/snowstorm/snomed-ct';
                        break;
                    case '2':
                        newUrl = 'https://snowstorm.ihtsdotools.org';
                        break;
                    case '3':
                        newUrl = 'https://tx.fhir.org/r4';
                        break;
                    case '4':
                        newUrl = 'http://localhost:8080';
                        break;
                    case '5':
                        newUrl = prompt('Enter custom server URL:', currentUrl) || currentUrl;
                        break;
                    default:
                        if (choice.startsWith('http')) {
                            newUrl = choice;
                        }
                        break;
                }
                
                if (newUrl && newUrl !== currentUrl) {
                    SNOMED_CONFIG.baseUrl = newUrl.replace(/\/$/, ''); // Remove trailing slash
                    
                    const newBranch = prompt(
                        `Configure SNOMED CT Branch:\n\nCurrent: ${currentBranch}\n\nCommon branches:\n- MAIN (International)\n- MAIN/SNOMEDCT-US (US Edition)\n- MAIN/SNOMEDCT-UK (UK Edition)\n\nEnter branch name (or press Cancel to keep current):`,
                        currentBranch
                    );
                    
                    if (newBranch && newBranch !== currentBranch) {
                        SNOMED_CONFIG.branch = newBranch;
                    }
                    
                    // Update the MRCM service with new config
                    mrcmService.config = SNOMED_CONFIG;
                    
                    alert(`Configuration updated!\n\nServer: ${SNOMED_CONFIG.baseUrl}\nBranch: ${SNOMED_CONFIG.branch}\n\nThe HRCM data will be refreshed from the new server.`);
                    
                                    // Find and refresh any visible HRCM sections
                const hrcmElements = document.querySelectorAll('[id^="hrcm-content-"]');
                hrcmElements.forEach(element => {
                    // Extract section ID from element ID pattern "hrcm-content-{sectionId}-{random}"
                    const idParts = element.id.split('-');
                    if (idParts.length >= 3) {
                        const sectionId = idParts[2];
                        window.refreshHRCM(element.id, sectionId);
                    }
                });
                }
            }
        };

        // Expose app object to global scope for onclick handlers
        window.app = app;

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            (async () => {
                console.log('üìö Loading markdown sections...');
                await loadMarkdownSections();
                console.log(`‚úÖ Loaded ${guideData.sections.length} sections`);
                
                app.init();
                
                // Handle URL immediately after sections are loaded
                if (app.handleURLOnLoad) {
                    app.handleURLOnLoad();
                }
            })();
        });

        /* --------------------------------------
           Dynamic Markdown Sections Loader
           --------------------------------------*/
        // Load hierarchical structure from hierarchy.json
        async function loadMarkdownSections() {
            try {
                const response = await fetch('output/hierarchy.json');
                if (!response.ok) {
                    console.warn('No hierarchical structure found, falling back to file-list.json');
                    return loadFallbackSections();
                }
                const hierarchy = await response.json();
                
                // Store hierarchy for navigation
                guideData.hierarchy = hierarchy;
                
                // Flatten hierarchy into sections for compatibility while preserving structure
                function addSectionsFromHierarchy(items, parentCategory = null, level = 0) {
                    items.forEach(item => {
                        if (item.files) {
                            item.files.forEach(file => {
                                // Skip if section already exists
                                if (guideData.sections.some(s => s.id === file.id)) {
                                    return;
                                }
                                
                                const sectionData = {
                                    id: file.id,
                                    title: file.title,
                                    icon: 'article',
                                    description: '',
                                    mdFile: `output/${file.file}`,
                                    category: item.title,
                                    categoryId: item.id,
                                    categoryPath: item.path,
                                    level: level,
                                    parentCategory: parentCategory
                                };
                                
                                guideData.sections.push(sectionData);
                                guideData.hierarchicalSections.push(sectionData); // Maintain hierarchical order
                            });
                        }
                        
                        if (item.subcategories) {
                            addSectionsFromHierarchy(item.subcategories, item.title, level + 1);
                        }
                    });
                }
                
                addSectionsFromHierarchy(hierarchy);
                
                console.log(`Loaded ${guideData.sections.length} sections from hierarchical structure`);
                console.log('Sample sections:', guideData.sections.slice(0, 5).map(s => s.id));
            } catch (e) {
                console.error('Error loading hierarchical sections:', e);
                return loadFallbackSections();
            }
        }

        // Fallback to original file-list.json method
        async function loadFallbackSections() {
            try {
                const response = await fetch('output/file-list.json');
                if (!response.ok) {
                    console.warn('No fallback sections found');
                    return;
                }
                const mdList = await response.json();
                mdList.forEach(item => {
                    if (guideData.sections.some(s => s.id === item.id)) return;
                    guideData.sections.push({
                        id: item.id,
                        title: item.title,
                        icon: 'article',
                        description: '',
                        mdFile: `output/${item.id}.md`
                    });
                });
                console.log(`Loaded ${mdList.length} sections from fallback`);
            } catch (e) {
                console.error('Error loading fallback sections:', e);
            }
        }
    </script>
</body>
</html>
